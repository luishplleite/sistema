<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Pedidos - TimePulse AI</title>
    <meta name="description" content="Gerencie pedidos, acompanhe entregas e controle seu negócio">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    
    <style>
        :root {
            --primary-color: #28a745;
            --primary-dark: #1e7e34;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --border-radius: 8px;
            --transition: all 0.3s ease;
            --sidebar-width: 280px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .dashboard-layout {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: var(--sidebar-width);
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
            z-index: 1000;
            transition: var(--transition);
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 2rem 1.5rem;
            border-bottom: 1px solid #e9ecef;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .restaurant-name {
            font-size: 0.9rem;
            opacity: 0.8;
            color: #6c757d;
        }

        .sidebar-nav {
            padding: 1rem;
        }

        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-section-title {
            padding: 0 1.5rem;
            color: #6c757d;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: #495057;
            text-decoration: none;
            transition: var(--transition);
            border-radius: var(--border-radius);
            margin-bottom: 0.25rem;
        }

        .nav-link:hover, .nav-link.active {
            background: rgba(40, 167, 69, 0.1);
            color: var(--primary-color);
        }

        .nav-icon {
            margin-right: 0.75rem;
            font-size: 1.1rem;
            width: 20px;
            text-align: center;
        }

        .main-content {
            margin-left: var(--sidebar-width);
            flex: 1;
            min-height: 100vh;
            background-color: #f8f9fa;
            transition: var(--transition);
        }

        .page-header {
            background: white;
            border-bottom: 1px solid #e9ecef;
            padding: 2rem;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            color: var(--dark-color);
        }

        .page-title i {
            margin-right: 1rem;
            color: var(--primary-color);
        }

        .page-subtitle {
            color: #6c757d;
            font-size: 1rem;
        }

        .page-actions {
            margin-top: 1rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .filters-section {
            background: white;
            border-bottom: 1px solid #e9ecef;
            padding: 1.5rem 2rem;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--dark-color);
        }

        .filter-input, .form-input {
            padding: 0.75rem;
            border: 1px solid #ced4da;
            border-radius: var(--border-radius);
            font-size: 0.875rem;
            transition: var(--transition);
            width: 100%;
        }

        .filter-input:focus, .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            text-decoration: none;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            gap: 0.5rem;
            white-space: nowrap;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid #ced4da;
            color: var(--dark-color);
        }

        .btn-outline:hover {
            background-color: #e9ecef;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }

        .orders-section {
            padding: 2rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .section-header-left h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
        }

        .section-header-left h2 i {
            margin-right: 0.75rem;
            color: var(--primary-color);
        }

        .section-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .section-header-right {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .online-toggle, .fullscreen-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            border: 1px solid #ced4da;
            border-radius: var(--border-radius);
            background: white;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            white-space: nowrap;
        }

        .online-toggle.online {
            border-color: var(--success-color);
            color: var(--success-color);
        }

        .online-toggle.offline {
            border-color: #6c757d;
            color: #6c757d;
        }

        .sector-filters {
            margin-bottom: 2rem;
        }

        .sector-filters-container {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .sector-filter-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: 2px solid #e9ecef;
            border-radius: var(--border-radius);
            background: white;
            color: var(--dark-color);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
        }

        .sector-filter-btn.active {
            border-color: var(--primary-color);
            background-color: var(--primary-color);
            color: white;
        }

        .sector-filter-btn:hover:not(.active) {
            border-color: var(--primary-color);
            background-color: rgba(25, 118, 210, 0.05);
        }

        .orders-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .order-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: var(--transition);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            height: auto;
            min-height: 200px;
        }

        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .order-number {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--dark-color);
        }

        .order-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            white-space: nowrap;
        }

        .status-novo { background: #fff3cd; color: #856404; }
        .status-aceito { background: #d1ecf1; color: #0c5460; }
        .status-preparo { background: #d1ecf1; color: #0c5460; }
        .status-pronto { background: #d4edda; color: #155724; }
        .status-saiu_entrega { background: #e2e3e5; color: #383d41; }
        .status-entregue { background: #d4edda; color: #155724; }
        .status-Aberta { background: #cce7ff; color: #004085; }
        .status-encerrado { background: #f8f9fa; color: #6c757d; }
        .status-rejeitado { background: #f8d7da; color: #721c24; }
        .status-cancelado { background: #f8d7da; color: #721c24; }

        .order-type {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .order-type-icon {
            padding: 0.5rem;
            border-radius: 50%;
            background: rgba(25, 118, 210, 0.1);
            color: var(--primary-color);
        }

        .order-customer {
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 0.5rem;
            word-break: break-word;
        }

        .order-details {
            margin: 1rem 0;
            flex: 1;
        }

        .order-detail {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: #6c757d;
        }

        .order-detail i {
            width: 16px;
            text-align: center;
            flex-shrink: 0;
        }

        .order-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid #e9ecef;
            margin-top: auto;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .order-total {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .order-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4rem;
            color: #6c757d;
        }

        .loading i {
            font-size: 2rem;
            margin-bottom: 1rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 1rem;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            width: 100%;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: white;
            z-index: 1;
        }

        .modal-header h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark-color);
            margin: 0;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
            padding: 0.5rem;
            border-radius: 50%;
            transition: var(--transition);
        }

        .modal-close:hover {
            background-color: #f8f9fa;
            color: var(--dark-color);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .order-type-selection {
            text-align: center;
        }

        .order-type-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 0.5rem;
        }

        .order-type-subtitle {
            color: #6c757d;
            margin-bottom: 2rem;
        }

        .order-type-buttons {
            display: grid;
            gap: 1rem;
        }

        .order-type-btn {
            padding: 1.5rem;
            border: 2px solid #e9ecef;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            text-align: left;
        }

        .order-type-btn:hover {
            border-color: var(--primary-color);
            background-color: rgba(25, 118, 210, 0.05);
        }

        .order-type-btn.delivery:hover { border-color: #007bff; background-color: rgba(0, 123, 255, 0.05); }
        .order-type-btn.balcao:hover { border-color: #fd7e14; background-color: rgba(253, 126, 20, 0.05); }
        .order-type-btn.mesa:hover { border-color: #28a745; background-color: rgba(40, 167, 69, 0.05); }

        .order-type-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .order-type-btn.delivery .order-type-icon { color: #007bff; }
        .order-type-btn.balcao .order-type-icon { color: #fd7e14; }
        .order-type-btn.mesa .order-type-icon { color: #28a745; }

        .order-type-name {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--dark-color);
        }

        .order-type-description {
            color: #6c757d;
            line-height: 1.5;
        }

        .new-order-notification-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 3000;
            display: none;
        }

        .new-order-notification-modal.show {
            display: block;
            animation: bounceIn 0.5s ease-out;
        }

        @keyframes bounceIn {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            60% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .new-order-notification-content {
            background: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            min-width: 300px;
            max-width: 90vw;
            border-left: 5px solid var(--success-color);
        }

        .new-order-notification-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .new-order-notification-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark-color);
            margin-bottom: 0.5rem;
        }

        .new-order-notification-subtitle {
            color: #6c757d;
            margin-bottom: 1.5rem;
        }

        .form-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 1px solid #e9ecef;
            border-radius: var(--border-radius);
        }

        .form-section h4 {
            margin-bottom: 0.5rem;
            color: var(--dark-color);
        }

        .form-text {
            margin-bottom: 1rem;
        }

        .add-ons-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .add-on-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border: 1px solid #e9ecef;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .add-on-item:hover {
            background-color: #f8f9fa;
        }

        .add-on-item input {
            margin-right: 0.75rem;
        }

        .add-on-item label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            cursor: pointer;
            margin: 0;
        }

        .add-on-name {
            font-weight: 500;
        }

        .add-on-price {
            color: var(--success-color);
            font-weight: 600;
        }

        #activateSoundBtn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            display: none;
        }

        /* Estilos específicos para o modal de delivery atualizado */
        .delivery-modal .modal-content {
            max-width: 600px;
        }

        .delivery-form-section {
            margin-bottom: 1.5rem;
        }

        .delivery-form-section h4 {
            margin-bottom: 1rem;
            color: var(--success-color);
            font-size: 1rem;
            font-weight: 600;
        }

        .delivery-form-grid {
            display: grid;
            gap: 0.75rem;
        }

        .delivery-form-grid-2 {
            grid-template-columns: 1fr 1fr;
        }

        .delivery-info-section {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .delivery-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            text-align: center;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: var(--border-radius);
        }

        .metric-item {
            display: flex;
            flex-direction: column;
        }

        .metric-label {
            font-size: 0.75rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
            font-weight: 500;
        }

        .metric-value {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--dark-color);
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .checkbox-container input[type="checkbox"] {
            margin: 0;
            transform: scale(1.2);
        }

        .fee-input-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .fee-input-container span {
            font-weight: 500;
        }

        .fee-input {
            width: 100px;
            text-align: right;
        }

        .delivery-total-section {
            background: var(--success-color);
            color: white;
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-top: 1rem;
        }

        .delivery-total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .delivery-total-row:last-child {
            margin-bottom: 0;
            font-size: 1.1rem;
            font-weight: 600;
            padding-top: 0.5rem;
            border-top: 1px solid rgba(255,255,255,0.3);
        }

        .delivery-items-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
            border: 1px solid #e9ecef;
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .delivery-items-table th, .delivery-items-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .delivery-items-table thead th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
            font-size: 0.8rem;
        }

        .delivery-items-table tbody td {
            vertical-align: middle;
        }

        .no-items-message {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 2rem;
        }

        .delivery-items-table tbody tr.empty-row {
            height: 60px;
        }

        .delivery-items-table tbody tr.empty-row td {
            border: none;
            background: transparent;
        }

        .highlighted-field {
            background-color: #d4edda !important;
            border-color: var(--success-color) !important;
        }

        .modal-body-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        
        .product-list-container {
            display: grid;
            gap: 0.5rem;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            max-height: 40vh;
            overflow-y: auto;
            padding: 0.5rem;
            border: 1px solid #e9ecef;
            border-radius: var(--border-radius);
        }

        .product-list-item {
            padding: 0.75rem;
            border: 1px solid #e9ecef;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            background-color: #fff;
        }
        
        .product-list-item:hover {
            background-color: #f8f9fa;
        }

        .product-list-item-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 0.25rem;
        }

        .product-list-item .product-name {
            font-weight: 600;
            color: var(--dark-color);
        }

        .product-list-item .product-price {
            font-weight: 500;
            color: var(--primary-color);
        }

        .product-list-item-description {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .items-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        
        .items-table th, .items-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        
        .items-table thead th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .item-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }
        
        .item-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: #6c757d;
            transition: color 0.2s;
        }
        
        .item-action-btn:hover {
            color: #212529;
        }

        .item-actions .delete:hover { color: var(--danger-color); }
        .item-actions .edit:hover { color: var(--info-color); }

        .route-info-grid {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            text-align: center;
        }
        
        .route-metric {
            background: #f8f9fa;
            padding: 0.75rem;
            border-radius: var(--border-radius);
            flex: 1;
        }

        .route-metric-label {
            font-size: 0.8rem;
            color: #6c757d;
            font-weight: 500;
        }

        .route-metric-value {
            font-size: 1rem;
            font-weight: 600;
        }
        
        /* Estilos específicos para o modal de delivery atualizado */
        .delivery-modal .modal-content {
            max-width: 600px;
        }

        .delivery-form-section {
            margin-bottom: 1.5rem;
        }

        .delivery-form-section h4 {
            margin-bottom: 1rem;
            color: var(--primary-color);
            font-size: 1rem;
            font-weight: 600;
        }

        .delivery-form-grid {
            display: grid;
            gap: 0.75rem;
        }

        .delivery-form-grid-2 {
            grid-template-columns: 1fr 1fr;
        }

        .delivery-info-section {
            background: #f8f9fa;
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .delivery-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        .metric-item {
            display: flex;
            flex-direction: column;
        }

        .metric-label {
            font-size: 0.75rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
            font-weight: 500;
        }

        .metric-value {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--dark-color);
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checkbox-container input[type="checkbox"] {
            margin: 0;
            transform: scale(1.2);
        }

        .fee-input-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .fee-input-container span {
            font-weight: 500;
        }

        .fee-input {
            width: 100px;
            text-align: right;
        }

        .delivery-total-section {
            background: var(--primary-color);
            color: white;
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-top: 1rem;
        }

        .delivery-total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .delivery-total-row:last-child {
            margin-bottom: 0;
            font-size: 1.1rem;
            font-weight: 600;
            padding-top: 0.5rem;
            border-top: 1px solid rgba(255,255,255,0.3);
        }

        .delivery-items-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
            border: 1px solid #e9ecef;
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .delivery-items-table th, .delivery-items-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .delivery-items-table thead th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .delivery-items-table tbody td {
            vertical-align: middle;
        }

        .no-items-message {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 2rem;
        }

        .highlighted-field {
            background-color: #d4edda !important;
            border-color: var(--success-color) !important;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e9ecef;
            border-top: none;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .product-search-name {
            font-weight: 600;
            color: var(--dark-color);
        }

        .product-search-price {
            color: var(--primary-color);
            font-weight: 500;
        }

        .product-search-category {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .product-search-container {
            position: relative;
        }

        .search-result-item {
            padding: 0.75rem;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .search-result-item:hover {
            background-color: #f8f9fa;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin-bottom: 0.5rem;
            color: var(--dark-color);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            color: white;
            font-weight: 500;
            z-index: 10000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background-color: var(--success-color);
        }

        .notification.error {
            background-color: var(--danger-color);
        }

        .notification.warning {
            background-color: var(--warning-color);
            color: var(--dark-color);
        }

        .notification.info {
            background-color: var(--info-color);
        }

        @media (max-width: 768px) {
            .delivery-form-grid-2 {
                grid-template-columns: 1fr;
            }

            .delivery-metrics {
                grid-template-columns: 1fr;
            }
            .modal-body-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .delivery-form-grid-2 {
                grid-template-columns: 1fr;
            }

            .delivery-metrics {
                grid-template-columns: 1fr;
            }

            .modal-content {
                max-width: 95vw;
                margin: 0.5rem;
            }

            .order-list-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .order-main-info {
                width: 100%;
                flex-direction: column;
                gap: 1rem;
            }

            .order-meta {
                width: 100%;
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-layout">
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">TimePulse AI</div>
                <div class="restaurant-name" id="restaurantName">Carregando...</div>
            </div>
            
            <div class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Principal</div>
                    <a href="dashboard.html" class="nav-link">
                        <span class="nav-icon">📊</span>
                        Dashboard
                    </a>
                    <a href="gestao_pedidos.html" class="nav-link active">
                        <span class="nav-icon">📦</span>
                        Pedidos
                    </a>
                    <a href="cozinha.html" class="nav-link">
                        <span class="nav-icon">👨‍🍳</span>
                        Cozinha
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Gestão</div>
                    <a href="cardapio.html" class="nav-link">
                        <span class="nav-icon">🍽️</span>
                        Cardápio
                    </a>
                    <a href="gestao_entregadores.html" class="nav-link">
                        <span class="nav-icon">🏍️</span>
                        Entregadores
                    </a>
                    <a href="clientes.html" class="nav-link">
                        <span class="nav-icon">👥</span>
                        Clientes
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Relatórios</div>
                    <a href="relatorios.html" class="nav-link">
                        <span class="nav-icon">📈</span>
                        Análises
                    </a>
                    <a href="historico_pedidos.html" class="nav-link">
                        <span class="nav-icon">📋</span>
                        Histórico
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Sistema</div>
                    <a href="configuracoes.html" class="nav-link">
                        <span class="nav-icon">⚙️</span>
                        Configurações
                    </a>
                    <a href="#" class="nav-link" onclick="signOut()">
                        <span class="nav-icon">🚪</span>
                        Sair
                    </a>
                </div>
            </div>
        </nav>

        <main class="main-content" id="mainContent">
            <div class="page-header" id="pageHeader">
                <h1 class="page-title">
                    <i class="fas fa-shopping-cart"></i>
                    Gestão de Pedidos
                </h1>
                <p class="page-subtitle">Acompanhe e gerencie todos os pedidos em tempo real</p>
                
                <div class="page-actions">
                </div>
            </div>

            <div class="filters-section" id="filtersSection">
                <div class="filters-grid">
                    <div class="filter-group">
                        <label class="filter-label">Status</label>
                        <select id="statusFilter" class="filter-input">
                            <option value="">Todos os status</option>
                            <option value="novo">Novo</option>
                            <option value="aceito">Aceito</option>
                            <option value="preparo">Em Preparo</option>
                            <option value="pronto">Pronto</option>
                            <option value="saiu_entrega">Saiu para Entrega</option>
                            <option value="Aberta">Aberta (Mesa)</option>
                            <option value="encerrado">Encerrado</option>
                            <option value="rejeitado">Rejeitado</option>
                            <option value="entregue">Entregue</option>
                            <option value="cancelado">Cancelado</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Buscar</label>
                        <input type="text" id="searchInput" class="filter-input" placeholder="Cliente, telefone ou número do pedido">
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Data</label>
                        <input type="date" id="dateFilter" class="filter-input">
                    </div>
                    
                    <div class="filter-group">
                        <button class="btn btn-primary" onclick="applyFilters()">
                            <i class="fas fa-search"></i>
                            Filtrar
                        </button>
                    </div>
                    
                    <div class="filter-group">
                        <button class="btn btn-secondary" onclick="clearFilters()">
                            <i class="fas fa-times"></i>
                            Limpar
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="orders-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2>
                            <i class="fas fa-list"></i>
                            Pedidos Recentes (<span id="ordersCount">0</span>)
                        </h2>
                        <div class="section-actions">
                            <button class="btn btn-primary btn-sm" onclick="openOrderTypeSelectionModal()">
                                <i class="fas fa-plus"></i>
                                Novo Pedido
                            </button>
                            
                            <button class="btn btn-secondary btn-sm" onclick="refreshOrders()">
                                <i class="fas fa-sync-alt"></i>
                                Atualizar
                            </button>
                        </div>
                    </div>
                    <div class="section-header-right">
                        <button class="online-toggle" id="onlineToggle" onclick="toggleOnlineStatus()">
                            <i class="fas fa-circle" id="onlineIcon"></i>
                            <span id="onlineText">Carregando...</span>
                        </button>
                        <button class="fullscreen-toggle" id="fullscreenToggle" onclick="toggleFullscreen()">
                            <i class="fas fa-expand" id="fullscreenIcon"></i>
                            <span id="fullscreenText">Tela Cheia</span>
                        </button>
                    </div>
                </div>

                <div class="sector-filters">
                    <div class="sector-filters-container">
                        <button class="sector-filter-btn active" data-sector="todos" onclick="filterBySector('todos')">
                            <i class="fas fa-th-large"></i>
                            <span>TODOS</span>
                        </button>
                        <button class="sector-filter-btn" data-sector="delivery" onclick="filterBySector('delivery')">
                            <i class="fas fa-motorcycle"></i>
                            <span>DELIVERY</span>
                        </button>
                        <button class="sector-filter-btn" data-sector="balcao" onclick="filterBySector('balcao')">
                            <i class="fas fa-shopping-bag"></i>
                            <span>BALCÃO</span>
                        </button>
                        <button class="sector-filter-btn" data-sector="mesa" onclick="filterBySector('mesa')">
                            <i class="fas fa-utensils"></i>
                            <span>MESA</span>
                        </button>
                    </div>
                </div>
                
                <div class="orders-container" id="ordersGrid">
                    <div class="loading" id="loadingState">
                        <i class="fas fa-spinner"></i>
                        <p>Carregando pedidos...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="modal" id="orderTypeSelectionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Novo Pedido</h3>
                <button class="modal-close" onclick="closeOrderTypeSelectionModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="order-type-selection">
                    <h2 class="order-type-title">Escolha o tipo de pedido</h2>
                    <p class="order-type-subtitle">Selecione a modalidade do seu novo pedido</p>
                    
                    <div class="order-type-buttons">
                        <div class="order-type-btn delivery" onclick="selectOrderType('delivery')">
                            <div class="order-type-icon">
                                <i class="fas fa-motorcycle"></i>
                            </div>
                            <div class="order-type-name">Delivery</div>
                            <div class="order-type-description">
                                Pedido com entrega no endereço do cliente. Inclui cálculo de frete e dados completos.
                            </div>
                        </div>
                        
                        <div class="order-type-btn balcao" onclick="selectOrderType('balcao')">
                            <div class="order-type-icon">
                                <i class="fas fa-shopping-bag"></i>
                            </div>
                            <div class="order-type-name">Balcão</div>
                            <div class="order-type-description">
                                Pedido para retirada no balcão. Cliente busca o pedido no estabelecimento.
                            </div>
                        </div>
                        
                        <div class="order-type-btn mesa" onclick="selectOrderType('mesa')">
                            <div class="order-type-icon">
                                <i class="fas fa-utensils"></i>
                            </div>
                            <div class="order-type-name">Mesa</div>
                            <div class="order-type-description">
                                Pedido para consumo no local. Cliente é atendido em uma mesa específica.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="new-order-notification-modal" id="newOrderNotificationModal">
        <div class="new-order-notification-content">
            <div class="new-order-notification-icon">
                🔔
            </div>
            <div class="new-order-notification-title">
                NOVO PEDIDO!
            </div>
            <div class="new-order-notification-subtitle" id="newOrderDetails">
                Pedido recebido
            </div>
            <div style="margin-top: 1.5rem;">
                <button class="btn btn-success" onclick="acceptNewOrderFromNotification()">
                    <i class="fas fa-check"></i>
                    Aceitar Pedido
                </button>
                <button class="btn btn-secondary" onclick="hideNewOrderNotification()" style="margin-left: 0.5rem;">
                    Ver Depois
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Novo Pedido - Delivery (Atualizado conforme a imagem) -->
    <div class="modal delivery-modal" id="deliveryOrderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-motorcycle"></i> Novo Pedido - Delivery</h3>
                <button class="modal-close" onclick="closeDeliveryOrderModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <form id="deliveryOrderForm">
                    <!-- Dados do Cliente -->
                    <div class="delivery-form-section">
                        <h4>Dados do Cliente</h4>
                        
                        <div class="delivery-form-grid delivery-form-grid-2">
                            <div>
                                <label class="filter-label">Telefone *</label>
                                <input type="tel" id="deliveryCustomerPhone" class="form-input" placeholder="(11) 99999-9999" required>
                            </div>
                            <div>
                                <label class="filter-label">Nome do Cliente *</label>
                                <input type="text" id="deliveryCustomerName" class="form-input" placeholder="Nome completo" required>
                            </div>
                        </div>

                        <div class="delivery-form-grid delivery-form-grid-2" style="margin-top: 0.75rem;">
                            <div>
                                <label class="filter-label">CEP</label>
                                <input type="text" id="deliveryCep" class="form-input" placeholder="11065001" maxlength="8" onblur="pesquisacep(this.value, 'delivery')">
                            </div>
                            <div>
                                <label class="filter-label">Rua</label>
                                <input type="text" id="deliveryRua" class="form-input" placeholder="Avenida Doutor Bernardino de Ca" readonly>
                            </div>
                        </div>

                        <div class="delivery-form-grid delivery-form-grid-2" style="margin-top: 0.75rem;">
                            <div>
                                <label class="filter-label">Número</label>
                                <input type="text" id="deliveryNumber" class="form-input" placeholder="551">
                            </div>
                            <div>
                                <label class="filter-label">Complemento</label>
                                <input type="text" id="deliveryComplement" class="form-input" placeholder="Apto, Casa, etc.">
                            </div>
                        </div>

                        <div class="delivery-form-grid" style="margin-top: 0.75rem;">
                            <div>
                                <label class="filter-label">Bairro</label>
                                <input type="text" id="deliveryBairro" class="form-input highlighted-field" placeholder="Gonzaga" readonly>
                            </div>
                        </div>

                        <div class="delivery-form-grid delivery-form-grid-2" style="margin-top: 0.75rem;">
                            <div>
                                <label class="filter-label">Cidade</label>
                                <input type="text" id="deliveryCidade" class="form-input" placeholder="Santos" readonly>
                            </div>
                            <div>
                                <label class="filter-label">UF</label>
                                <input type="text" id="deliveryUf" class="form-input" placeholder="SP" maxlength="2" readonly>
                            </div>
                        </div>
                        <!-- Campo oculto para o endereço completo -->
                        <input type="hidden" id="deliveryAddress">
                    </div>

                    <!-- Itens do Pedido -->
                    <div class="delivery-form-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h4 style="margin: 0;">Itens do Pedido</h4>
                            <button type="button" class="btn btn-primary btn-sm" onclick="openProductSelectionModal('delivery')">
                                <i class="fas fa-plus"></i> Adicionar Item
                            </button>
                        </div>
                        
                        <div class="product-search-container">
                            <input type="text" id="deliveryProductSearch" class="form-input" placeholder="Buscar produto (nome ou código)..." oninput="ordersManager.performProductSearch(this.value.trim(), 'delivery')">
                            <div id="deliverySearchResults" class="search-results"></div>
                        </div>
                        
                        <table class="delivery-items-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Qtd</th>
                                    <th>Preço</th>
                                    <th>Total</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="deliveryItemsTableBody">
                                <tr class="no-items-row">
                                    <td colspan="5">Nenhum item adicionado ainda. Use a busca acima ou o botão "Adicionar Item".</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Cálculo de Entrega -->
                    <div class="delivery-form-section">
                        <h4>Cálculo de Entrega</h4>
                        
                        <div class="delivery-info-section">
                            <div class="checkbox-container">
                                <input type="checkbox" id="deliveryIncludeRoundtrip">
                                <label for="deliveryIncludeRoundtrip">Incluir retorno (ida e volta)</label>
                            </div>
                            
                            <div class="delivery-metrics">
                                <div class="metric-item">
                                    <span class="metric-label">Distância</span>
                                    <span class="metric-value">1,3 km</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Tempo Estimado</span>
                                    <span class="metric-value">4 min</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Taxa de Entrega</span>
                                    <span class="metric-value">R$ <span id="deliveryFeeDisplay">8,00</span></span>
                                </div>
                            </div>
                            
                            <div class="fee-input-container">
                                <span>Taxa de Entrega:</span>
                                <span>R$</span>
                                <input type="number" id="deliveryFee" class="form-input fee-input" value="8.00" step="0.01" min="0">
                            </div>
                        </div>
                    </div>

                    <!-- Forma de Pagamento -->
                    <div class="delivery-form-section">
                        <div>
                            <label class="filter-label">Forma de Pagamento *</label>
                            <select id="deliveryPaymentMethod" class="form-input" onchange="toggleDeliveryChangeFields()" required>
                                <option value="">Selecione...</option>
                                <option value="money">Dinheiro</option>
                                <option value="card">Cartão</option>
                                <option value="pix">PIX</option>
                                <option value="voucher">Vale</option>
                            </select>
                        </div>
                        <div id="deliveryChangeFields" style="margin-top: 1rem; display: none;">
                            <div class="delivery-form-grid delivery-form-grid-2">
                                <div>
                                    <label class="filter-label">Cliente paga:</label>
                                    <input type="number" id="deliveryChangeForAmount" class="form-input" step="0.01" placeholder="0,00" oninput="calculateDeliveryChange()">
                                </div>
                                <div>
                                    <label class="filter-label">Troco:</label>
                                    <input type="number" id="deliveryChangeAmount" class="form-input" step="0.01" placeholder="0,00" readonly>
                                </div>
                            </div>
                            <div id="deliveryChangeCalculation" style="margin-top: 0.5rem; padding: 0.5rem; background: #d4edda; border-radius: var(--border-radius); display: none;">
                                <strong>Troco: R$ <span id="deliveryChangeDisplay">0,00</span></strong>
                            </div>
                        </div>
                    </div>

                    <!-- Total -->
                    <div class="delivery-total-section">
                        <div class="delivery-total-row">
                            <span>Subtotal:</span>
                            <span>R$ <span id="deliverySubtotalDisplay">0,00</span></span>
                        </div>
                        <div class="delivery-total-row">
                            <span>Taxa de Entrega:</span>
                            <span>R$ <span id="deliveryFeeDisplayTotal">8,00</span></span>
                        </div>
                        <div class="delivery-total-row">
                            <span>Total:</span>
                            <span>R$ <input type="hidden" id="deliverySubtotal"><input type="hidden" id="deliveryTotal"><span id="deliveryTotalDisplay">8,00</span></span>
                        </div>
                    </div>

                    <!-- Observações -->
                    <div class="delivery-form-section">
                        <div>
                            <label class="filter-label">Observações do Pedido</label>
                            <textarea id="deliveryOrderNotes" class="form-input" rows="2" placeholder="Observações especiais"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            
            <div style="padding: 1.5rem; border-top: 1px solid #e9ecef; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                <button class="btn btn-secondary" onclick="closeDeliveryOrderModal()">Cancelar</button>
                <button class="btn btn-success" onclick="submitDeliveryOrder()">
                    <i class="fas fa-check"></i> Criar Pedido
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="balcaoOrderModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3><i class="fas fa-shopping-bag"></i> Novo Pedido - Balcão</h3>
                <button class="modal-close" onclick="closeBalcaoOrderModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <form id="balcaoOrderForm">
                    <div class="modal-body-grid">
                        <div>
                            <h4 style="margin-bottom: 1rem; color: var(--primary-color);">Dados do Cliente</h4>
                            
                            <div style="margin-bottom: 1rem;">
                                <label class="filter-label">Nome do Cliente *</label>
                                <input type="text" id="balcaoCustomerName" class="form-input" placeholder="Nome completo" required>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label class="filter-label">Telefone</label>
                                <input type="tel" id="balcaoCustomerPhone" class="form-input" placeholder="(11) 99999-9999">
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label class="filter-label">Previsão de Retirada</label>
                                <input type="time" id="balcaoPickupTime" class="form-input">
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label class="filter-label">Forma de Pagamento *</label>
                                <select id="balcaoPaymentMethod" class="form-input" onchange="toggleBalcaoChangeFields()" required>
                                    <option value="">Selecione...</option>
                                    <option value="money">Dinheiro</option>
                                    <option value="card">Cartão</option>
                                    <option value="pix">PIX</option>
                                    <option value="voucher">Vale</option>
                                </select>
                            </div>
                            
                            <div id="balcaoChangeFields" style="margin-bottom: 1rem; display: none;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                    <div>
                                        <label class="filter-label">Cliente paga:</label>
                                        <input type="number" id="balcaoChangeForAmount" class="form-input" step="0.01" placeholder="0,00" onchange="calculateBalcaoChange()">
                                    </div>
                                    <div>
                                        <label class="filter-label">Troco:</label>
                                        <input type="number" id="balcaoChangeAmount" class="form-input" step="0.01" placeholder="0,00" readonly>
                                    </div>
                                </div>
                                <div id="balcaoChangeCalculation" style="margin-top: 0.5rem; padding: 0.5rem; background: #d4edda; border-radius: var(--border-radius); display: none;">
                                    <strong>Troco: R$ <span id="balcaoChangeDisplay">0,00</span></strong>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label class="filter-label">Observações</label>
                                <textarea id="balcaoNotes" class="form-input" rows="3" placeholder="Observações especiais"></textarea>
                            </div>
                        </div>
                        
                        <div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h4 style="color: var(--primary-color);">Itens do Pedido</h4>
                                <button type="button" class="btn btn-primary btn-sm" onclick="openProductSelectionModal('balcao')">
                                    <i class="fas fa-plus"></i> Adicionar Item
                                </button>
                            </div>
                            
                            <div class="product-search-container">
                                <input type="text" id="balcaoProductSearch" class="form-input" placeholder="Buscar produto (nome ou código)..." oninput="ordersManager.performProductSearch(this.value.trim(), 'balcao')">
                                <div id="balcaoSearchResults" class="search-results"></div>
                            </div>
                            
                            <div style="border: 1px solid #e9ecef; border-radius: var(--border-radius); overflow: hidden;">
                                <table class="items-table">
                                    <thead>
                                        <tr>
                                            <th>Item</th>
                                            <th>Qtd</th>
                                            <th>Preço</th>
                                            <th>Total</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="balcaoItemsTableBody">
                                        <tr class="no-items-row">
                                            <td colspan="5">Nenhum item adicionado ainda. Use a busca acima ou o botão "Adicionar Item".</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div style="margin-top: 1rem; padding: 1rem; background: var(--primary-color); color: white; border-radius: var(--border-radius); text-align: center;">
                                <h4 style="margin: 0; display: flex; justify-content: space-between;">
                                    <span>Total:</span>
                                    <span>R$ <input type="hidden" id="balcaoSubtotal"><input type="hidden" id="balcaoTotal"><span id="balcaoTotalDisplay">0,00</span></span>
                                </h4>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem;">
                        <label class="filter-label">Observações do Pedido</label>
                        <textarea id="balcaoOrderNotes" class="form-input" rows="2" placeholder="Observações especiais"></textarea>
                    </div>
                </form>
            </div>
            
            <div style="padding: 1.5rem; border-top: 1px solid #e9ecef; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                <button class="btn btn-secondary" onclick="closeBalcaoOrderModal()">Cancelar</button>
                <button class="btn btn-success" onclick="submitBalcaoOrder()">
                    <i class="fas fa-check"></i> Criar Pedido
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="mesaOrderModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3><i class="fas fa-utensils"></i> Novo Pedido - Mesa</h3>
                <button class="modal-close" onclick="closeMesaOrderModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <form id="mesaOrderForm">
                    <div class="modal-body-grid">
                        <div>
                            <h4 style="margin-bottom: 1rem; color: var(--primary-color);">Informações da Mesa</h4>
                            
                            <div style="margin-bottom: 1rem;">
                                <label class="filter-label">Número da Mesa *</label>
                                <input type="text" id="mesaNumber" class="form-input" placeholder="Número da mesa" required onblur="checkMesaAvailability()">
                            </div>
                            
                            <div id="mesaAvailabilityMessage" style="display: none; margin-bottom: 1rem; padding: 1rem; border-radius: var(--border-radius);">
                                <!-- Dynamic content will be inserted here -->
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label class="filter-label">Nome do Cliente</label>
                                <input type="text" id="mesaCustomerName" class="form-input" placeholder="Nome (opcional)">
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label class="filter-label">Número de Pessoas</label>
                                <input type="number" id="mesaPeopleCount" class="form-input" min="1" max="20" placeholder="Quantas pessoas?">
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label class="filter-label">Garçom Responsável</label>
                                <select id="mesaWaiter" class="form-input">
                                    <option value="">Selecione o garçom</option>
                                    <option value="garcom1">João Silva</option>
                                    <option value="garcom2">Maria Santos</option>
                                    <option value="garcom3">Pedro Costa</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label class="filter-label">Forma de Pagamento</label>
                                <select id="mesaPaymentMethod" class="form-input" onchange="toggleMesaChangeFields()">
                                    <option value="">Deixar para depois</option>
                                    <option value="money">Dinheiro</option>
                                    <option value="card">Cartão</option>
                                    <option value="pix">PIX</option>
                                    <option value="voucher">Vale</option>
                                </select>
                            </div>
                            
                            <div id="mesaChangeFields" style="margin-bottom: 1rem; display: none;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                    <div>
                                        <label class="filter-label">Cliente paga:</label>
                                        <input type="number" id="mesaChangeForAmount" class="form-input" step="0.01" placeholder="0,00" onchange="calculateMesaChange()">
                                    </div>
                                    <div>
                                        <label class="filter-label">Troco:</label>
                                        <input type="number" id="mesaChangeAmount" class="form-input" step="0.01" placeholder="0,00" readonly>
                                    </div>
                                </div>
                                <div id="mesaChangeCalculation" style="margin-top: 0.5rem; padding: 0.5rem; background: #d4edda; border-radius: var(--border-radius); display: none;">
                                    <strong>Troco: R$ <span id="mesaChangeDisplay">0,00</span></strong>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label class="filter-label">Observações</label>
                                <textarea id="mesaOrderNotes" class="form-input" rows="2" placeholder="Observações especiais"></textarea>
                            </div>
                        </div>
                        
                        <div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h4 style="color: var(--primary-color);">Itens do Pedido</h4>
                                <button type="button" class="btn btn-primary btn-sm" onclick="openProductSelectionModal('mesa')">
                                    <i class="fas fa-plus"></i> Adicionar Item
                                </button>
                            </div>
                            
                            <div class="product-search-container">
                                <input type="text" id="mesaProductSearch" class="form-input" placeholder="Buscar produto (nome ou código)..." oninput="ordersManager.performProductSearch(this.value.trim(), 'mesa')">
                                <div id="mesaSearchResults" class="search-results"></div>
                            </div>
                            
                            <div style="border: 1px solid #e9ecef; border-radius: var(--border-radius); overflow: hidden;">
                                <table class="items-table">
                                    <thead>
                                        <tr>
                                            <th>Item</th>
                                            <th>Qtd</th>
                                            <th>Preço</th>
                                            <th>Total</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="mesaItemsTableBody">
                                        <tr class="no-items-row">
                                            <td colspan="5">Nenhum item adicionado ainda. Use a busca acima ou o botão "Adicionar Item".</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div id="mesaServiceFeeSection" style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: var(--border-radius);">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <label for="mesaServiceFee">Taxa de Serviço (10%):</label>
                                    <input type="checkbox" id="mesaServiceFee" checked>
                                </div>
                            </div>
                            
                            <div style="margin-top: 1rem; padding: 1rem; background: var(--primary-color); color: white; border-radius: var(--border-radius); text-align: center;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Subtotal:</span>
                                    <span>R$ <span id="mesaSubtotalDisplay">0,00</span></span>
                                </div>
                                <div id="mesaServiceFeeDisplayDiv" style="display: flex; justify-content: space-between;">
                                    <span>Taxa de Serviço:</span>
                                    <span>R$ <span id="mesaServiceFeeDisplay">0,00</span></span>
                                </div>
                                <hr style="margin: 0.5rem 0; border-color: rgba(255,255,255,0.3);">
                                <h4 style="margin: 0; display: flex; justify-content: space-between;">
                                    <span>Total:</span>
                                    <span>R$ <input type="hidden" id="mesaTotal"><span id="mesaTotalDisplay">0,00</span></span>
                                </h4>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem;">
                        <label class="filter-label">Observações do Pedido</label>
                        <textarea id="mesaOrderNotes" class="form-input" rows="2" placeholder="Observações especiais"></textarea>
                    </div>
                </form>
            </div>
            
            <div style="padding: 1.5rem; border-top: 1px solid #e9ecef; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                <button class="btn btn-secondary" onclick="closeMesaOrderModal()">Cancelar</button>
                <button class="btn btn-success" onclick="submitMesaOrder()">
                    <i class="fas fa-check"></i> Criar Pedido
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="productSelectionModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3><i class="fas fa-shopping-cart"></i> Selecionar Produtos</h3>
                <button class="modal-close" onclick="closeProductSelectionModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <div style="margin-bottom: 1.5rem;">
                    <input type="text" id="productSearchInput" class="form-input" placeholder="Buscar produtos..." onkeyup="filterProducts()">
                </div>
                
                <div id="productCategories" style="max-height: 60vh; overflow-y: auto;">
                    <!-- Product categories will be loaded here -->
                </div>
            </div>
            
            <div style="padding: 1.5rem; border-top: 1px solid #e9ecef; display: flex; justify-content: space-between;">
                <button class="btn btn-secondary" onclick="closeProductSelectionModal()">Fechar</button>
            </div>
        </div>
    </div>

    <div class="modal" id="orderDetailsModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 id="orderDetailsTitle">Detalhes do Pedido</h3>
                <button class="modal-close" onclick="closeOrderDetailsModal()">&times;</button>
            </div>
            
            <div class="modal-body" id="orderDetailsBody">
                <!-- Order details will be populated here -->
            </div>
            
            <div style="padding: 1.5rem; border-top: 1px solid #e9ecef; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 1rem;" id="orderDetailsActions">
                <!-- Action buttons will be populated here -->
            </div>
        </div>
    </div>

    <div class="modal" id="addProductModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3><i class="fas fa-plus"></i> Adicionar Produto</h3>
                <button class="modal-close" onclick="closeAddProductModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <div style="margin-bottom: 1.5rem;">
                    <input type="text" id="productSearchInput" class="form-input" placeholder="Buscar produtos...">
                </div>
                
                <div class="modal-body-grid">
                    <div>
                        <label class="filter-label">Categoria</label>
                        <select id="categoriesSelect" class="form-input">
                            <option value="">Carregando categorias...</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="filter-label">Produto</label>
                        <select id="productsSelect" class="form-input" size="8">
                            <option value="">Carregando produtos...</option>
                        </select>
                    </div>
                </div>
                
                <div id="selectedProductSection" style="margin-top: 1.5rem; display: none;">
                    <h4 style="color: var(--primary-color); margin-bottom: 1rem;">Produto Selecionado</h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <div>
                            <label class="filter-label">Nome do Produto</label>
                            <input type="text" id="selectedProductName" class="form-input" readonly>
                        </div>
                        
                        <div>
                            <label class="filter-label">Quantidade</label>
                            <input type="number" id="selectedProductQuantity" class="form-input" value="1" min="1">
                        </div>
                        
                        <div>
                            <label class="filter-label">Preço Unitário</label>
                            <input type="number" id="selectedProductPrice" class="form-input" step="0.01" min="0">
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem;">
                        <label class="filter-label">Observações</label>
                        <textarea id="selectedProductNotes" class="form-input" rows="2" placeholder="Observações especiais"></textarea>
                    </div>
                </div>
            </div>
            
            <div style="padding: 1.5rem; border-top: 1px solid #e9ecef; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                <button class="btn btn-secondary" onclick="closeAddProductModal()">Cancelar</button>
                <button class="btn btn-success" id="addProductBtn" onclick="addProductToOrder()" disabled>
                    <i class="fas fa-check"></i> Adicionar Produto
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="editItemModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> Editar Item</h3>
                <button class="modal-close" onclick="closeEditItemModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <div style="margin-bottom: 1rem;">
                    <label class="filter-label">Nome do Produto</label>
                    <input type="text" id="editItemName" class="form-input" readonly>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div>
                        <label class="filter-label">Quantidade</label>
                        <input type="number" id="editItemQuantity" class="form-input" min="1">
                    </div>
                    
                    <div>
                        <label class="filter-label">Preço Unitário</label>
                        <input type="number" id="editItemPrice" class="form-input" step="0.01" min="0">
                    </div>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label class="filter-label">Observações</label>
                    <textarea id="editItemNotes" class="form-input" rows="2" placeholder="Observações especiais"></textarea>
                </div>
            </div>
            
            <div style="padding: 1.5rem; border-top: 1px solid #e9ecef; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                <button class="btn btn-secondary" onclick="closeEditItemModal()">Cancelar</button>
                <button class="btn btn-success" onclick="updateOrderItem()">
                    <i class="fas fa-check"></i> Salvar Alterações
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="delivererSelectionModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-motorcycle"></i> Selecionar Entregador</h3>
                <button class="modal-close" onclick="closeDelivererSelectionModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <div style="margin-bottom: 1.5rem;">
                    <label class="filter-label">Entregador</label>
                    <select id="delivererSelect" class="form-input">
                        <option value="">Carregando entregadores...</option>
                    </select>
                </div>
            </div>
            
            <div style="padding: 1.5rem; border-top: 1px solid #e9ecef; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                <button class="btn btn-secondary" onclick="closeDelivererSelectionModal()">Cancelar</button>
                <button class="btn btn-success" onclick="confirmDelivererSelection()">
                    <i class="fas fa-check"></i> Confirmar
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="paymentMethodModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-credit-card"></i> Forma de Pagamento</h3>
                <button class="modal-close" onclick="closePaymentMethodModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <div style="margin-bottom: 1.5rem;">
                    <label class="filter-label">Como o cliente pagou?</label>
                    <select id="finalPaymentMethod" class="form-input" onchange="toggleFinalChangeFields()">
                        <option value="">Selecione a forma de pagamento</option>
                        <option value="money">Dinheiro</option>
                        <option value="card">Cartão</option>
                        <option value="pix">PIX</option>
                        <option value="voucher">Vale</option>
                    </select>
                </div>
                
                <div id="finalChangeFields" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label class="filter-label">Cliente pagou:</label>
                            <input type="number" id="finalChangeForAmount" class="form-input" step="0.01" placeholder="0,00" onchange="calculateFinalChange()">
                        </div>
                        <div>
                            <label class="filter-label">Troco:</label>
                            <input type="number" id="finalChangeAmount" class="form-input" step="0.01" placeholder="0,00" readonly>
                        </div>
                    </div>
                    <div id="finalChangeCalculation" style="padding: 1rem; background: #d4edda; border-radius: var(--border-radius); display: none;">
                        <strong>Troco: R$ <span id="finalChangeDisplay">0,00</span></strong>
                    </div>
                </div>
            </div>
            
            <div style="padding: 1.5rem; border-top: 1px solid #e9ecef; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                <button class="btn btn-secondary" onclick="closePaymentMethodModal()">Cancelar</button>
                <button class="btn btn-success" onclick="confirmPaymentAndFinish()">
                    <i class="fas fa-check"></i> Finalizar Entrega
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="finalizarMesaModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-utensils"></i> Finalizar Mesa</h3>
                <button class="modal-close" onclick="closeFinalizarMesaModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <form id="finalizarMesaForm">
                    <div style="margin-bottom: 1.5rem; text-align: center; padding: 1rem; background: #f8f9fa; border-radius: var(--border-radius);">
                        <h4 style="margin: 0; color: var(--primary-color);">Total: R$ <span id="mesaFinalTotalDisplay">0,00</span></h4>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label class="filter-label">Forma de Pagamento *</label>
                        <select id="mesaFinalPaymentMethod" class="form-input" onchange="toggleFinalMesaChangeFields()" required>
                            <option value="">Selecione a forma de pagamento</option>
                            <option value="money">Dinheiro</option>
                            <option value="card">Cartão</option>
                            <option value="pix">PIX</option>
                            <option value="voucher">Vale</option>
                        </select>
                    </div>
                    
                    <div id="mesaFinalChangeFields" style="display: none;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label class="filter-label">Cliente pagou:</label>
                                <input type="number" id="mesaFinalChangeForAmount" class="form-input" step="0.01" placeholder="0,00" onchange="calculateFinalMesaChange()">
                            </div>
                            <div>
                                <label class="filter-label">Troco:</label>
                                <input type="number" id="mesaFinalChangeAmount" class="form-input" step="0.01" placeholder="0,00" readonly>
                            </div>
                        </div>
                        <div id="mesaFinalChangeCalculation" style="padding: 1rem; background: #d4edda; border-radius: var(--border-radius); display: none;">
                            <strong>Troco: R$ <span id="mesaFinalChangeDisplay">0,00</span></strong>
                        </div>
                    </div>
                </form>
            </div>
            
            <div style="padding: 1.5rem; border-top: 1px solid #e9ecef; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                <button class="btn btn-secondary" onclick="closeFinalizarMesaModal()">Cancelar</button>
                <button class="btn btn-success" onclick="confirmMesaPaymentAndFinish()">
                    <i class="fas fa-check"></i> Encerrar Mesa
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="customerRegistrationModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> Cadastrar Novo Cliente</h3>
                <button class="modal-close" onclick="closeCustomerRegistrationModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <form id="customerRegistrationForm">
                    <div class="modal-body-grid">
                        <div>
                            <label class="filter-label">Nome Completo *</label>
                            <input type="text" id="newCustomerName" class="form-input" placeholder="Nome completo" required>
                        </div>
                        
                        <div>
                            <label class="filter-label">Telefone *</label>
                            <input type="tel" id="newCustomerPhone" class="form-input" placeholder="(11) 99999-9999" required>
                        </div>
                        
                        <div>
                            <label class="filter-label">E-mail</label>
                            <input type="email" id="newCustomerEmail" class="form-input" placeholder="email@exemplo.com">
                        </div>
                        
                        <div>
                            <label class="filter-label">Data de Nascimento</label>
                            <input type="date" id="newCustomerBirthDate" class="form-input">
                        </div>
                        
                        <div>
                            <label class="filter-label">CEP</label>
                            <input type="text" id="newCustomerCep" class="form-input" placeholder="00000-000" maxlength="9" oninput="formatCEP(this)" onblur="pesquisacep(this.value, 'newCustomer');">
                        </div>
                        
                        <div>
                            <label class="filter-label">Rua</label>
                            <input type="text" id="newCustomerRua" class="form-input" placeholder="Rua" readonly>
                        </div>
                        
                        <div>
                            <label class="filter-label">Número</label>
                            <input type="text" id="newCustomerNumber" class="form-input" placeholder="Número">
                        </div>
                        
                        <div>
                            <label class="filter-label">Complemento</label>
                            <input type="text" id="newCustomerComplement" class="form-input" placeholder="Apto, Casa, etc.">
                        </div>
                        
                        <div>
                            <label class="filter-label">Bairro</label>
                            <input type="text" id="newCustomerBairro" class="form-input" placeholder="Bairro" readonly>
                        </div>
                        
                        <div>
                            <label class="filter-label">Cidade</label>
                            <input type="text" id="newCustomerCidade" class="form-input" placeholder="Cidade" readonly>
                        </div>
                        
                        <div>
                            <label class="filter-label">UF</label>
                            <input type="text" id="newCustomerUf" class="form-input" placeholder="UF" maxlength="2" readonly>
                        </div>
                        
                        <div style="display: none;">
                            <input type="text" id="ibge" class="form-input">
                        </div>
                    </div>
                </form>
            </div>
            
            <div style="padding: 1.5rem; border-top: 1px solid #e9ecef; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                <button class="btn btn-secondary" onclick="closeCustomerRegistrationModal()">Cancelar</button>
                <button class="btn btn-success" onclick="handleCustomerRegistration(event)">
                    <i class="fas fa-check"></i> Cadastrar Cliente
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="addOnsModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="addOnsModalTitle"><i class="fas fa-plus"></i> Adicionais</h3>
                <button class="modal-close" onclick="closeAddOnsModal()">&times;</button>
            </div>
            
            <div class="modal-body" id="addOnsModalBody">
                <div id="addOnsLoading" style="text-align: center; padding: 2rem;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                    <p>Carregando adicionais...</p>
                </div>
                
                <div id="addOnsContent" style="display: none;">
                    <!-- Add-ons content will be populated here -->
                </div>
            </div>
            
            <div style="padding: 1.5rem; border-top: 1px solid #e9ecef; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                <button class="btn btn-secondary" onclick="closeAddOnsModal()">Cancelar</button>
                <button class="btn btn-success" onclick="confirmAddOnsSelection()">
                    <i class="fas fa-check"></i> Confirmar
                </button>
            </div>
        </div>
    </div>

    <button id="activateSoundBtn" class="btn btn-warning" style="display: none;">
        <i class="fas fa-volume-up"></i>
        Ativar Som
    </button>

  <script>
// ===== CONFIGURAÇÕES GLOBAIS E INICIALIZAÇÃO =====
const SUPABASE_URL = 'https://sguirxaunajirfvlzbac.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNndWlyeGF1bmFqaXJmdmx6YmFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAwOTQ4MDIsImV4cCI6MjA2NTY3MDgwMn0.5vQj3LmBbpP0WosMwreboRww97wZyXBByQqG8oaI59k';

// IMPORTANTE: Substitua pela sua chave de acesso real do Mapbox
const MAPBOX_ACCESS_TOKEN = 'pk.eyJ1IjoibGhwbCIsImEiOiJjbWN6bHlubGIweWl1MmpvajJjNDZsMTB1In0.VknoAZV_yynQiYi4nR3JjQ';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ===== VARIÁVEIS GLOBAIS =====
let orders = [];
let filteredOrders = [];
let currentRestaurant = null;
let realtimeSubscription = null;
let isFullscreenMode = false;
let isOnline = false;
let realtimeInterval = null;
let audioContext = null;
let newOrderOscillator = null;
let newOrderCheckInterval = null;
let currentNewOrderForNotification = null;
let audioContextResumed = false;
let soundLoopInterval = null;
let acceptedOrdersInterval = null;
let currentSectorFilter = 'todos';
let currentOrderForProducts = null;
let currentEditingItem = null;
let products = [];
let selectedProduct = null;
let isNewOrderContext = false;
let currentOrderMode = 'delivery';
let currentOrderContext = 'delivery';
let newOrderItems = [];
let routeCalculationTimeout;
let currentOrderForMesaFinalization = null;
let currentOrderForPayment = null;
let deliverers = [];
let ordersManager;

// Variáveis globais para o alerta sonoro
let soundIntervals = {};
let newOrderSoundEnabled = true;

// ===== VARIÁVEIS PARA ADICIONAIS =====
let currentProductForAddOns = null;
let currentOrderContextForAddOns = null;
let currentDeliveryCoordinates = null;
let currentEstimatedDeliveryTime = null;
let currentDeliveryDistance = null;

// Variável global para armazenar o contexto para o callback da busca de CEP
let currentCepContext = null;

// ===== FUNÇÕES DO MAPBOX E GEOCODIFICAÇÃO =====
async function geocodeAddress(address) {
    try {
        const encodedAddress = encodeURIComponent(address);
        const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodedAddress}.json?access_token=${MAPBOX_ACCESS_TOKEN}&country=br&limit=1`;

        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`Erro na geocodificação: ${response.status}`);
        }

        const data = await response.json();

        if (data.features && data.features.length > 0) {
            const coordinates = data.features[0].center;
            return {
                longitude: coordinates[0],
                latitude: coordinates[1],
                formatted_address: data.features[0].place_name
            };
        }
        throw new Error('Endereço não encontrado');
    } catch (error) {
        console.error('❌ Erro na geocodificação:', error);
        throw error;
    }
}

async function calculateRouteDistance(restaurantCoords, deliveryCoords, includeRoundtrip = false) {
    try {
        let coordinates;

        if (includeRoundtrip) {
            coordinates = `${restaurantCoords.longitude},${restaurantCoords.latitude};${deliveryCoords.longitude},${deliveryCoords.latitude};${restaurantCoords.longitude},${restaurantCoords.latitude}`;
        } else {
            coordinates = `${restaurantCoords.longitude},${restaurantCoords.latitude};${deliveryCoords.longitude},${deliveryCoords.latitude}`;
        }

        const url = `https://api.mapbox.com/directions/v5/mapbox/driving-traffic/${coordinates}?access_token=${MAPBOX_ACCESS_TOKEN}&geometries=geojson&overview=simplified`;

        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`Erro no cálculo da rota: ${response.status}`);
        }

        const data = await response.json();

        if (data.routes && data.routes.length > 0) {
            const route = data.routes[0];
            return {
                distance: route.distance / 1000, // Converte de metros para km
                duration: route.duration / 60, // Converte de segundos para minutos
                geometry: route.geometry
            };
        }
        throw new Error('Rota não encontrada');
    } catch (error) {
        console.error('❌ Erro no cálculo da rota:', error);
        throw error;
    }
}

function calculateDeliveryFee(distance, includeRoundtrip = false) {
    const minimumDistanceKm = currentRestaurant?.minimum_distance_km || 3.0;
    const minimumDeliveryFee = currentRestaurant?.minimum_delivery_fee || 8.00;
    const deliveryFeePerKm = currentRestaurant?.delivery_fee_per_km || 0.50;
    const deliveryReturnPerKm = currentRestaurant?.delivery_return_per_km || 0.12;

    if (includeRoundtrip) {
        const oneWayDistance = distance / 2;
        let outboundCost = minimumDeliveryFee;
        if (oneWayDistance > minimumDistanceKm) {
            const extraDistance = oneWayDistance - minimumDistanceKm;
            outboundCost += extraDistance * deliveryFeePerKm;
        }
        const returnCost = oneWayDistance * deliveryReturnPerKm;
        const totalFee = outboundCost + returnCost;
        return { totalFee: totalFee };
    } else {
        let totalFee = minimumDeliveryFee;
        if (distance > minimumDistanceKm) {
            const extraDistance = distance - minimumDistanceKm;
            totalFee += extraDistance * deliveryFeePerKm;
        }
        return { totalFee: totalFee };
    }
}

async function calculateDeliveryRoute() {
    const deliveryAddress = document.getElementById('deliveryAddress').value.trim();
    const includeRoundtrip = document.getElementById('deliveryIncludeRoundtrip').checked;
    const deliveryFeeInput = document.getElementById('deliveryFee');
    const deliveryFeeDisplay = document.getElementById('deliveryFeeDisplay');
    const deliveryFeeDisplayTotal = document.getElementById('deliveryFeeDisplayTotal');
    const routeInfoContainer = document.querySelector('.delivery-metrics');

    if (!deliveryAddress || !currentRestaurant?.latitude || !currentRestaurant?.longitude) {
        if (routeInfoContainer) {
            routeInfoContainer.innerHTML = `
                <div class="metric-item">
                    <span class="metric-label">Distância</span>
                    <span class="metric-value">-- km</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Tempo Estimado</span>
                    <span class="metric-value">-- min</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Taxa de Entrega</span>
                    <span class="metric-value">--</span>
                </div>
            `;
        }
        if (deliveryFeeInput) deliveryFeeInput.value = '0.00';
        if (deliveryFeeDisplay) deliveryFeeDisplay.textContent = '0,00';
        if (deliveryFeeDisplayTotal) deliveryFeeDisplayTotal.textContent = '0,00';
        if (ordersManager) ordersManager.updateDeliveryOrderDisplays();
        return;
    }

    if (routeInfoContainer) {
        routeInfoContainer.innerHTML = `
            <div class="route-loading">
                <i class="fas fa-spinner fa-spin"></i>
                Calculando rota...
            </div>
        `;
    }
    if (deliveryFeeInput) deliveryFeeInput.value = '0.00';
    if (deliveryFeeDisplay) deliveryFeeDisplay.textContent = '0,00';
    if (deliveryFeeDisplayTotal) deliveryFeeDisplayTotal.textContent = '0,00';
    if (ordersManager) ordersManager.updateDeliveryOrderDisplays();

    try {
        const restaurantCoords = {
            longitude: currentRestaurant.longitude,
            latitude: currentRestaurant.latitude
        };
        const deliveryCoords = await geocodeAddress(deliveryAddress);

        const routeData = await calculateRouteDistance(restaurantCoords, deliveryCoords, includeRoundtrip);

        currentDeliveryDistance = routeData.distance;
        currentEstimatedDeliveryTime = routeData.duration;
        currentDeliveryCoordinates = deliveryCoords;

        const fee = calculateDeliveryFee(routeData.distance, includeRoundtrip);

        if (deliveryFeeInput) deliveryFeeInput.value = fee.totalFee.toFixed(2);
        if (deliveryFeeDisplay) deliveryFeeDisplay.textContent = fee.totalFee.toFixed(2).replace('.', ',');
        if (deliveryFeeDisplayTotal) deliveryFeeDisplayTotal.textContent = fee.totalFee.toFixed(2).replace('.', ',');
        if (ordersManager) ordersManager.updateDeliveryOrderDisplays();

        if (routeInfoContainer) {
            routeInfoContainer.innerHTML = `
                <div class="route-info-grid">
                    <div class="route-metric">
                        <div class="route-metric-label">Distância</div>
                        <div class="route-metric-value">${routeData.distance.toFixed(1).replace('.', ',')} km</div>
                    </div>
                    <div class="route-metric">
                        <div class="route-metric-label">Tempo Estimado</div>
                        <div class="route-metric-value">${Math.round(routeData.duration)} min</div>
                    </div>
                    <div class="route-metric">
                        <div class="route-metric-label">Taxa de Entrega</div>
                        <div class="route-metric-value">R$ ${fee.totalFee.toFixed(2).replace('.', ',')}</div>
                    </div>
                </div>
            `;
        }
    } catch (error) {
        console.error('❌ Erro no cálculo da rota:', error);
        if (routeInfoContainer) {
            routeInfoContainer.innerHTML = `
                <div class="route-error">
                    <i class="fas fa-exclamation-triangle"></i>
                    Erro ao calcular rota. Verifique o endereço.
                </div>
            `;
        }
    }
}

function pesquisacep(valor, context) {
    currentCepContext = context;
    const cepRegex = /^[0-9]{5}-?[0-9]{3}$/;
    valor = valor.replace(/\D/g, '');

    if (cepRegex.test(valor)) {
        limpa_formulário_cep(context);

        const script = document.createElement('script');
        script.src = `https://viacep.com.br/ws/${valor}/json/?callback=meu_callback`;
        document.body.appendChild(script);
    } else {
        limpa_formulário_cep(context);
        if (valor.length > 0) {
            if (ordersManager) ordersManager.showNotification('Formato de CEP inválido.', 'warning');
        }
    }
}

function meu_callback(conteudo) {
    const context = currentCepContext;

    if (!("erro" in conteudo)) {
        if (context === 'delivery') {
            document.getElementById('deliveryRua').value = (conteudo.logradouro);
            document.getElementById('deliveryBairro').value = (conteudo.bairro);
            document.getElementById('deliveryCidade').value = (conteudo.localidade);
            document.getElementById('deliveryUf').value = (conteudo.uf);
            document.getElementById('deliveryAddress').value = `${conteudo.logradouro}, ${document.getElementById('deliveryNumber').value}, ${document.getElementById('deliveryComplement').value}, ${conteudo.bairro}, ${conteudo.localidade} - ${conteudo.uf}`;
        } else if (context === 'newCustomer') {
            document.getElementById('newCustomerRua').value = (conteudo.logradouro);
            document.getElementById('newCustomerBairro').value = (conteudo.bairro);
            document.getElementById('newCustomerCidade').value = (conteudo.localidade);
            document.getElementById('newCustomerUf').value = (conteudo.uf);
        }
        calculateDeliveryRoute();
    } else {
        limpa_formulário_cep(context);
        if (ordersManager) ordersManager.showNotification("CEP não encontrado.", 'warning');
    }

    const scriptElements = document.getElementsByTagName('script');
    for (let i = 0; i < scriptElements.length; i++) {
        if (scriptElements[i].src.includes('viacep.com.br')) {
            document.body.removeChild(scriptElements[i]);
            break;
        }
    }
}

function limpa_formulário_cep(context) {
    if (context === 'delivery') {
        document.getElementById('deliveryRua').value = "";
        document.getElementById('deliveryBairro').value = "";
        document.getElementById('deliveryCidade').value = "";
        document.getElementById('deliveryUf').value = "";
        document.getElementById('deliveryAddress').value = "";
    } else if (context === 'newCustomer') {
        document.getElementById('newCustomerRua').value = "";
        document.getElementById('newCustomerBairro').value = "";
        document.getElementById('newCustomerCidade').value = "";
        document.getElementById('newCustomerUf').value = "";
    }
}

// ===== CLASSE PRINCIPAL =====
class OrdersManager {
    constructor() {
        this.orders = [];
        this.filteredOrders = [];
        this.editingOrderId = null;
        this.updateInterval = null;
        this.currentSearchPhone = null;
        this.currentOrderForDelivery = null;
        this.deliverers = [];
        this.currentOrderForProducts = null;
        this.currentEditingItem = null;
        this.products = [];
        this.selectedProduct = null;
        this.isNewOrderContext = false;
        this.currentOrderMode = 'delivery';
        this.currentOrderContext = 'delivery';
        this.newOrderItems = [];
        this.currentOrderForMesaFinalization = null;
        this.currentOrderForPayment = null;
        this.shownNewOrderIds = new Set();
    }

    async init() {
        console.log('🚀 Iniciando Gestão de Pedidos...');
        try {
            await this.loadRestaurantInfo();
            await this.loadOrders();
            await this.loadProducts();
            this.setupEventListeners();
            this.setupRealtimeUpdates();
            this.setupAutoRefresh();
            startNewOrderChecking();
            startAcceptedOrdersChecking();
            console.log('✅ Gestão de Pedidos iniciada com sucesso!');
        } catch (error) {
            console.error('❌ Erro ao inicializar:', error);
            this.showNotification('Erro ao carregar dados', 'error');
        }
    }

    async loadRestaurantInfo() {
        try {
            const restaurantId = localStorage.getItem('restaurant_id');
            if (!restaurantId) {
                // Se não houver ID no localStorage, o usuário não está autenticado.
                throw new Error('ID do restaurante não encontrado na sessão. Redirecionando...');
            }

            const { data: restaurant, error } = await supabase
                .from('restaurants')
                .select('*')
                .eq('id', restaurantId)
                .single();

            if (error) throw error;
            if (!restaurant) {
                throw new Error('Restaurante não encontrado. Verifique o ID.');
            }

            currentRestaurant = restaurant;
            const restaurantNameElement = document.getElementById('restaurantName');
            if (restaurantNameElement) {
                restaurantNameElement.textContent = restaurant.name;
            }

            if (restaurant.primary_color) {
                document.documentElement.style.setProperty('--primary-color', restaurant.primary_color);
            }

            isOnline = restaurant.pedidos_online || false;
            updateOnlineToggleUI();

            console.log('🏪 Restaurante carregado:', restaurant.name);
        } catch (error) {
            console.error('❌ Erro ao carregar restaurante:', error);
            // Redireciona para o login em caso de falha
            window.location.href = 'login.html';
            throw error; // Re-lança o erro para interromper a execução do init()
        }
    }

    async loadOrders() {
        try {
            const loadingElement = document.getElementById('loadingState');
            if (loadingElement) {
                loadingElement.style.display = 'block';
            }

            const restaurantId = localStorage.getItem('restaurant_id');
            if (!restaurantId) {
                throw new Error('ID do restaurante não encontrado para carregar pedidos.');
            }

            const { data: ordersData, error: ordersError } = await supabase
                .from('orders')
                .select('*')
                .eq('restaurant_id', restaurantId)
                .order('created_at', { ascending: false });

            if (ordersError) throw ordersError;

            const { data: itemsData, error: itemsError } = await supabase
                .from('order_items')
                .select('*')
                .in('order_id', ordersData.map(order => order.id));

            if (itemsError) throw itemsError;

            const ordersWithItems = ordersData.map(order => ({
                ...order,
                order_number: String(order.id).slice(-8).toUpperCase(),
                order_items: itemsData.filter(item => item.order_id === order.id)
            }));

            this.orders = ordersWithItems;

            // --- NOVO --- : Lógica para o alerta sonoro e modal
            const newOrders = this.orders.filter(order => order.status === 'novo');
            if (newOrders.length > 0 && newOrderSoundEnabled) {
                newOrders.forEach(order => {
                    if (!soundIntervals[order.id]) {
                        soundIntervals[order.id] = playNewOrderSoundLoop();
                        console.log(`🔊 Iniciando alerta sonoro para o pedido: #${order.order_number}`);
                    }
                });
            }

            for (const orderId in soundIntervals) {
                const orderExists = this.orders.some(o => o.id === orderId);
                const orderStatusIsNew = this.orders.find(o => o.id === orderId)?.status === 'novo';
                if (!orderExists || !orderStatusIsNew) {
                    stopNewOrderSound(orderId);
                    console.log(`🔇 Parando alerta sonoro para o pedido: #${this.orders.find(o => o.id === orderId)?.order_number || 'ID desconhecido'}`);
                }
            }


            const newOrderToShow = this.orders.find(order =>
                order.status === 'novo' && !this.shownNewOrderIds.has(order.id)
            );

            if (newOrderToShow) {
                console.log(`Abrindo detalhes para o novo pedido: #${newOrderToShow.order_number}`);
                this.openOrderDetails(newOrderToShow.id);
                this.shownNewOrderIds.add(newOrderToShow.id); // Marca como já exibido para não repetir
            }
            // --- FIM DA LÓGICA NOVA ---

            this.applyDefaultFilters();
            this.renderOrders();

            const ordersCountElement = document.getElementById('ordersCount');
            if (ordersCountElement) {
                ordersCountElement.textContent = this.filteredOrders.length;
            }

            if (loadingElement) {
                loadingElement.style.display = 'none';
            }

            console.log(`📦 ${this.orders.length} pedidos carregados, ${this.filteredOrders.length} visíveis`);
        } catch (error) {
            console.error('❌ Erro ao carregar pedidos:', error);
            this.showNotification('Erro ao carregar pedidos', 'error');
            const loadingElement = document.getElementById('loadingState');
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
        }
    }

    async loadProducts() {
        try {
            const restaurantId = localStorage.getItem('restaurant_id');
            if (!restaurantId) {
                throw new Error('ID do restaurante não encontrado para carregar produtos.');
            }

            const { data: products, error: productsError } = await supabase
                .from('products')
                .select('*')
                .eq('restaurant_id', restaurantId)
                .eq('active', true)
                .order('name');

            if (productsError) throw productsError;

            const { data: categories, error: categoriesError } = await supabase
                .from('product_categories')
                .select('*')
                .eq('restaurant_id', restaurantId)
                .eq('active', true);

            if (categoriesError) throw categoriesError;

            const productsWithCategories = products.map(product => ({
                ...product,
                product_categories: categories.find(cat => cat.id === product.category_id) || null
            }));

            this.products = productsWithCategories;
            return productsWithCategories;
        } catch (error) {
            console.error('❌ Erro ao carregar produtos:', error);
            this.showNotification('Erro ao carregar produtos', 'error');
            return [];
        }
    }

    async loadDeliverers() {
        try {
            const restaurantId = localStorage.getItem('restaurant_id');
            if (!restaurantId) {
                throw new Error('ID do restaurante não encontrado para carregar entregadores.');
            }

            // A consulta foi modificada para buscar apenas entregadores ativos e não ocupados
            const { data, error } = await supabase
                .from('deliverers')
                .select('*')
                .eq('restaurant_id', restaurantId)
                .eq('status', 'active'); // Filtra por status 'active'

            if (error) throw error;
            this.deliverers = data;
            return data;
        } catch (error) {
            console.error('❌ Erro ao carregar entregadores:', error);
            this.showNotification('Erro ao carregar entregadores.', 'error');
            return [];
        }
    }

    applyDefaultFilters() {
        this.filteredOrders = this.orders.filter(order => {
            return order.status !== 'entregue' && order.status !== 'cancelado' && order.status !== 'encerrado';
        });
    }

    applyFilters() {
        const statusElement = document.getElementById('statusFilter');
        const searchElement = document.getElementById('searchInput');
        const dateElement = document.getElementById('dateFilter');

        const status = statusElement ? statusElement.value : '';
        const search = searchElement ? searchElement.value.toLowerCase() : '';
        const date = dateElement ? dateElement.value : '';

        this.filteredOrders = this.orders.filter(order => {
            const orderSector = getOrderSector(order);
            if (currentSectorFilter !== 'todos' && orderSector !== currentSectorFilter) {
                return false;
            }

            if (status && status !== '') {
                if (order.status !== status) {
                    return false;
                }
            } else {
                if (order.status === 'entregue' || order.status === 'cancelado' || order.status === 'encerrado') {
                    return false;
                }
            }

            if (search && search !== '') {
                const searchInName = order.customer_name?.toLowerCase().includes(search);
                const searchInNumber = order.order_number?.toLowerCase().includes(search);
                const searchInPhone = order.customer_phone?.replace(/\D/g, '').includes(search.replace(/\D/g, ''));

                if (!searchInName && !searchInNumber && !searchInPhone) {
                    return false;
                }
            }

            if (date && date !== '') {
                const orderDate = order.created_at.split('T')[0];
                if (orderDate !== date) {
                    return false;
                }
            }

            return true;
        });

        this.renderOrders();
        const ordersCountElement = document.getElementById('ordersCount');
        if (ordersCountElement) {
            ordersCountElement.textContent = this.filteredOrders.length;
        }
    }

    clearFilters() {
        console.log('🔄 Limpando filtros...');
        const statusElement = document.getElementById('statusFilter');
        const searchElement = document.getElementById('searchInput');
        const dateElement = document.getElementById('dateFilter');

        if (statusElement) statusElement.value = '';
        if (searchElement) searchElement.value = '';
        if (dateElement) dateElement.value = '';

        currentSectorFilter = 'todos';
        document.querySelectorAll('.sector-filter-btn').forEach(btn => btn.classList.remove('active'));
        const todosBtn = document.querySelector('[data-sector="todos"]');
        if (todosBtn) todosBtn.classList.add('active');

        this.applyDefaultFilters();
        this.renderOrders();

        const ordersCountElement = document.getElementById('ordersCount');
        if (ordersCountElement) {
            ordersCountElement.textContent = this.filteredOrders.length;
        }
    }

    renderOrders() {
        const container = document.getElementById('ordersGrid');
        if (!container) {
            console.warn('Container ordersGrid não encontrado');
            return;
        }

        const loadingState = document.getElementById('loadingState');
        if (loadingState) {
            loadingState.style.display = 'none';
        }

        if (this.filteredOrders.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-shopping-cart"></i>
                    <h3>Nenhum pedido encontrado</h3>
                    <p>Novos pedidos aparecerão aqui automaticamente</p>
                </div>
            `;
            return;
        }

        container.innerHTML = this.filteredOrders.map(order => this.createOrderCard(order)).join('');
    }

    createOrderCard(order) {
        const statusClass = this.getStatusClass(order.status);
        const statusLabel = this.getStatusLabel(order.status);
        const timeAgo = this.getTimeAgo(order.created_at);
        const total = parseFloat(order.total || order.total_amount || 0);
        const orderSector = getOrderSector(order);
        const orderIcon = this.getOrderIcon(orderSector);

        return `
            <div class="order-card ${statusClass}" data-order-id="${order.id}" onclick="ordersManager.openOrderDetails('${order.id}')">
                <div class="order-header">
                    <div class="order-number">#${order.order_number}</div>
                    <div class="order-status ${order.status}">${statusLabel}</div>
                </div>

                <div class="order-type">
                    <div class="order-type-icon">
                        <i class="fas ${orderIcon}"></i>
                    </div>
                    <span>${this.getOrderTypeLabel(orderSector)}</span>
                </div>

                <div class="order-customer">${order.customer_name}</div>

                <div class="order-details">
                    <div class="order-detail">
                        <i class="fas fa-phone"></i>
                        <span>${order.customer_phone}</span>
                    </div>
                    <div class="order-detail">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>${order.delivery_address}</span>
                    </div>
                    <div class="order-detail">
                        <i class="fas fa-clock"></i>
                        <span>${timeAgo}</span>
                    </div>
                </div>

                <div class="order-footer">
                    <div class="order-total">R$ ${total.toFixed(2).replace('.', ',')}</div>
                    <div class="order-actions">
                        ${this.getOrderActions(order)}
                    </div>
                </div>
            </div>
        `;
    }

    getOrderIcon(sector) {
        const icons = {
            'delivery': 'fa-motorcycle',
            'balcao': 'fa-shopping-bag',
            'mesa': 'fa-utensils'
        };
        return icons[sector] || 'fa-shopping-cart';
    }

    getOrderTypeLabel(sector) {
        const labels = {
            'delivery': 'Delivery',
            'balcao': 'Balcão',
            'mesa': 'Mesa'
        };
        return labels[sector] || 'Pedido';
    }

    getOrderActions(order) {
        const actions = [];
        const orderSector = getOrderSector(order);
        switch (order.status) {
            case 'novo':
                actions.push(`<button class="btn btn-success btn-sm" onclick="event.stopPropagation(); ordersManager.updateOrderStatus('${order.id}', 'aceito')"><i class="fas fa-check"></i></button>`);
                actions.push(`<button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); ordersManager.updateOrderStatus('${order.id}', 'rejeitado')"><i class="fas fa-times"></i></button>`);
                break;
            case 'aceito':
                actions.push(`<button class="btn btn-warning btn-sm" onclick="event.stopPropagation(); ordersManager.updateOrderStatus('${order.id}', 'preparo')"><i class="fas fa-utensils"></i></button>`);
                break;
            case 'preparo':
                actions.push(`<button class="btn btn-success btn-sm" onclick="event.stopPropagation(); ordersManager.updateOrderStatus('${order.id}', 'pronto')"><i class="fas fa-check-circle"></i></button>`);
                break;
            case 'pronto':
                if (orderSector === 'delivery') {
                    actions.push(`<button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); openDelivererSelectionModal('${order.id}')"><i class="fas fa-motorcycle"></i></button>`);
                } else {
                    actions.push(`<button class="btn btn-success btn-sm" onclick="event.stopPropagation(); ordersManager.updateOrderStatusFromDetails('${order.id}', 'entregue')"><i class="fas fa-check-double"></i></button>`);
                }
                break;
            case 'saiu_entrega':
                actions.push(`<button class="btn btn-success btn-sm" onclick="event.stopPropagation(); openPaymentMethodModal('${order.id}')"><i class="fas fa-flag-checkered"></i></button>`);
                break;
            case 'Aberta':
                actions.push(`<button class="btn btn-success btn-sm" onclick="event.stopPropagation(); openFinalizarMesaModal('${order.id}')"><i class="fas fa-dollar-sign"></i></button>`);
                break;
        }
        return actions.join('');
    }

    renderDeliveryOrderItems() {
        const tbody = document.getElementById('deliveryItemsTableBody');
        if (!tbody) return;

        if (this.newOrderItems.length === 0) {
            tbody.innerHTML = `
                <tr class="no-items-row">
                    <td colspan="5">Nenhum item adicionado ainda. Use a busca acima ou o botão "Adicionar Item".</td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = this.newOrderItems.map((item, index) => `
                <tr>
                    <td>
                        <div class="item-name-cell">${item.name}</div>
                        ${item.notes ? `<div class="item-notes-cell">${item.notes}</div>` : ''}
                    </td>
                    <td class="item-quantity-cell">
                        <input type="number" value="${item.quantity}" min="1"
                                onchange="updateDeliveryOrderItemQuantity(${index}, this.value)"
                                style="width: 60px; text-align: center;">
                    </td>
                    <td class="item-price-cell">
                        <input type="number" value="${item.price.toFixed(2)}" step="0.01"
                                onchange="updateDeliveryOrderItemPrice(${index}, this.value)"
                                style="width: 80px; text-align: right;">
                    </td>
                    <td class="item-total-cell">R$ ${(item.quantity * item.price).toFixed(2).replace('.', ',')}</td>
                    <td>
                        <div class="item-actions">
                            <button type="button" class="item-action-btn edit" onclick="editDeliveryOrderItemNotes(${index})" title="Observações">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="item-action-btn delete" onclick="removeDeliveryOrderItem(${index})" title="Remover">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        this.updateDeliveryOrderDisplays();
    }

    renderBalcaoOrderItems() {
        const tbody = document.getElementById('balcaoItemsTableBody');
        if (!tbody) return;

        if (this.newOrderItems.length === 0) {
            tbody.innerHTML = `
                <tr class="no-items-row">
                    <td colspan="5">Nenhum item adicionado ainda. Use a busca acima ou o botão "Adicionar Item".</td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = this.newOrderItems.map((item, index) => `
                <tr>
                    <td>
                        <div class="item-name-cell">${item.name}</div>
                        ${item.notes ? `<div class="item-notes-cell">${item.notes}</div>` : ''}
                    </td>
                    <td class="item-quantity-cell">
                        <input type="number" value="${item.quantity}" min="1"
                                onchange="updateBalcaoOrderItemQuantity(${index}, this.value)"
                                style="width: 60px; text-align: center;">
                    </td>
                    <td class="item-price-cell">
                        <input type="number" value="${item.price.toFixed(2)}" step="0.01"
                                onchange="updateBalcaoOrderItemPrice(${index}, this.value)"
                                style="width: 80px; text-align: right;">
                    </td>
                    <td class="item-total-cell">R$ ${(item.quantity * item.price).toFixed(2).replace('.', ',')}</td>
                    <td>
                        <div class="item-actions">
                            <button type="button" class="item-action-btn edit" onclick="editBalcaoOrderItemNotes(${index})" title="Observações">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="item-action-btn delete" onclick="removeBalcaoOrderItem(${index})" title="Remover">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        this.updateBalcaoOrderDisplays();
    }

    renderMesaOrderItems() {
        const tbody = document.getElementById('mesaItemsTableBody');
        if (!tbody) return;

        if (this.newOrderItems.length === 0) {
            tbody.innerHTML = `
                <tr class="no-items-row">
                    <td colspan="5">Nenhum item adicionado ainda. Use a busca acima ou o botão "Adicionar Item".</td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = this.newOrderItems.map((item, index) => `
                <tr>
                    <td>
                        <div class="item-name-cell">${item.name}</div>
                        ${item.notes ? `<div class="item-notes-cell">${item.notes}</div>` : ''}
                    </td>
                    <td class="item-quantity-cell">
                        <input type="number" value="${item.quantity}" min="1"
                                onchange="updateMesaOrderItemQuantity(${index}, this.value)"
                                style="width: 60px; text-align: center;">
                    </td>
                    <td class="item-price-cell">
                        <input type="number" value="${item.price.toFixed(2)}" step="0.01"
                                onchange="updateMesaOrderItemPrice(${index}, this.value)"
                                style="width: 80px; text-align: right;">
                    </td>
                    <td class="item-total-cell">R$ ${(item.quantity * item.price).toFixed(2).replace('.', ',')}</td>
                    <td>
                        <div class="item-actions">
                            <button type="button" class="item-action-btn edit" onclick="editMesaOrderItemNotes(${index})" title="Observações">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="item-action-btn delete" onclick="removeMesaOrderItem(${index})" title="Remover">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        this.updateMesaOrderDisplays();
    }

    updateDeliveryOrderDisplays() {
        let subtotal = 0;
        this.newOrderItems.forEach(item => {
            subtotal += item.quantity * item.price;
        });

        const deliveryFeeInput = document.getElementById('deliveryFee');
        const deliveryFee = deliveryFeeInput ? parseFloat(deliveryFeeInput.value) || 0 : 0;
        const total = subtotal + deliveryFee;

        const subtotalDisplay = document.getElementById('deliverySubtotalDisplay');
        const feeDisplay = document.getElementById('deliveryFeeDisplayTotal');
        const totalDisplay = document.getElementById('deliveryTotalDisplay');

        if (subtotalDisplay) subtotalDisplay.textContent = subtotal.toFixed(2).replace('.', ',');
        if (feeDisplay) feeDisplay.textContent = deliveryFee.toFixed(2).replace('.', ',');
        if (totalDisplay) totalDisplay.textContent = total.toFixed(2).replace('.', ',');

        const subtotalHidden = document.getElementById('deliverySubtotal');
        const totalHidden = document.getElementById('deliveryTotal');
        if (subtotalHidden) subtotalHidden.value = subtotal.toFixed(2);
        if (totalHidden) totalHidden.value = total.toFixed(2);
    }

    updateBalcaoOrderDisplays() {
        let subtotal = 0;
        this.newOrderItems.forEach(item => {
            subtotal += item.quantity * item.price;
        });

        const totalDisplay = document.getElementById('balcaoTotalDisplay');
        if (totalDisplay) totalDisplay.textContent = subtotal.toFixed(2).replace('.', ',');

        const subtotalHidden = document.getElementById('balcaoSubtotal');
        const totalHidden = document.getElementById('balcaoTotal');
        if (subtotalHidden) subtotalHidden.value = subtotal.toFixed(2);
        if (totalHidden) totalHidden.value = subtotal.toFixed(2);
    }

    updateMesaOrderDisplays() {
        let subtotal = 0;
        this.newOrderItems.forEach(item => {
            subtotal += item.quantity * item.price;
        });

        const serviceFeeCheckbox = document.getElementById('mesaServiceFee');
        const serviceFee = serviceFeeCheckbox && serviceFeeCheckbox.checked ? subtotal * 0.10 : 0;
        const total = subtotal + serviceFee;

        const subtotalDisplay = document.getElementById('mesaSubtotalDisplay');
        const serviceFeeDisplay = document.getElementById('mesaServiceFeeDisplay');
        const totalDisplay = document.getElementById('mesaTotalDisplay');
        const serviceFeeDisplayDiv = document.getElementById('mesaServiceFeeDisplayDiv');

        if (subtotalDisplay) subtotalDisplay.textContent = subtotal.toFixed(2).replace('.', ',');
        if (serviceFeeDisplay) serviceFeeDisplay.textContent = serviceFee.toFixed(2).replace('.', ',');
        if (totalDisplay) totalDisplay.textContent = total.toFixed(2).replace('.', ',');
        if (serviceFee > 0 && serviceFeeDisplayDiv) {
            serviceFeeDisplayDiv.style.display = 'flex';
        } else if (serviceFeeDisplayDiv) {
            serviceFeeDisplayDiv.style.display = 'none';
        }

        const subtotalHidden = document.getElementById('mesaSubtotal');
        const totalHidden = document.getElementById('mesaTotal');
        if (subtotalHidden) subtotalHidden.value = subtotal.toFixed(2);
        if (totalHidden) totalHidden.value = total.toFixed(2);
    }

    async performProductSearch(searchTerm, context) {
        const resultsContainer = document.getElementById(`${context}SearchResults`);

        if (!resultsContainer) return;

        if (!searchTerm || searchTerm.length < 2) {
            resultsContainer.style.display = 'none';
            return;
        }

        const searchLower = searchTerm.toLowerCase();

        const filtered = this.products.filter(product => {
            const last4Digits = product.id.slice(-4);
            const productNameLower = product.name.toLowerCase();
            return productNameLower.includes(searchLower) || last4Digits.includes(searchTerm);
        });

        if (filtered.length > 0) {
            resultsContainer.innerHTML = filtered.slice(0, 5).map(product => {
                const last4Digits = product.id.slice(-4);
                const productJsonString = JSON.stringify(product).replace(/"/g, '&quot;');
                return `
                    <div class="search-result-item" onclick='handleProductSelection(${productJsonString}, "${context}")'>
                        <div class="product-search-name">${last4Digits} - ${product.name}</div>
                        <div class="product-search-price">R$ ${parseFloat(product.price).toFixed(2).replace('.', ',')}</div>
                        ${product.product_categories ? `<div class="product-search-category">${product.product_categories.name}</div>` : ''}
                    </div>
                `;
            }).join('');
            resultsContainer.style.display = 'block';
        } else {
            resultsContainer.innerHTML = `<div class="search-result-item" style="cursor: default;">Nenhum produto encontrado.</div>`;
            resultsContainer.style.display = 'block';
        }
    }

    updateNewOrderItemQuantity(index, quantity, context) {
        const qty = parseInt(quantity);
        if (qty > 0 && this.newOrderItems[index]) {
            this.newOrderItems[index].quantity = qty;
            switch (context) {
                case 'delivery':
                    this.renderDeliveryOrderItems();
                    break;
                case 'balcao':
                    this.renderBalcaoOrderItems();
                    break;
                case 'mesa':
                    this.renderMesaOrderItems();
                    break;
            }
        }
    }

    updateNewOrderItemPrice(index, price, context) {
        const priceValue = parseFloat(price);
        if (priceValue >= 0 && this.newOrderItems[index]) {
            this.newOrderItems[index].price = priceValue;
            switch (context) {
                case 'delivery':
                    this.renderDeliveryOrderItems();
                    break;
                case 'balcao':
                    this.renderBalcaoOrderItems();
                    break;
                case 'mesa':
                    this.renderMesaOrderItems();
                    break;
            }
        }
    }

    editNewOrderItemNotes(index, context) {
        if (!this.newOrderItems[index]) return;
        const newNotes = prompt('Observações do item:', this.newOrderItems[index].notes || '');
        if (newNotes !== null) {
            this.newOrderItems[index].notes = newNotes;
            switch (context) {
                case 'delivery':
                    this.renderDeliveryOrderItems();
                    break;
                case 'balcao':
                    this.renderBalcaoOrderItems();
                    break;
                case 'mesa':
                    this.renderMesaOrderItems();
                    break;
            }
        }
    }

    removeNewOrderItem(index, context) {
        showCustomConfirmation('Remover este item do pedido?', 'Remover Item').then(confirmed => {
            if (confirmed && this.newOrderItems[index]) {
                this.newOrderItems.splice(index, 1);
                switch (context) {
                    case 'delivery':
                        this.renderDeliveryOrderItems();
                        break;
                    case 'balcao':
                        this.renderBalcaoOrderItems();
                        break;
                    case 'mesa':
                        this.renderMesaOrderItems();
                        break;
                }
            }
        });
    }

    async saveOrder(orderData) {
        try {
            console.log('💾 Iniciando salvamento do pedido:', orderData);

            if (!orderData.items || orderData.items.length === 0) {
                throw new Error('Adicione pelo menos um item ao pedido');
            }

            // CORREÇÃO: Usa a função RPC para buscar o cliente de forma robusta
            let customer = null;
            if (orderData.customer_phone) {
                const { data: rpcData, error: rpcError } = await supabase
                    .rpc('get_customer_by_phone', {
                        p_phone_number: orderData.customer_phone,
                        p_restaurant_id: currentRestaurant?.id
                    });

                if (rpcError) {
                    // Ignora o erro se for apenas "nenhuma linha encontrada"
                    if (rpcError.code !== 'PGRST116' && !rpcError.message.includes('Result with 0 rows was returned')) {
                        throw rpcError;
                    }
                }
                // O RPC retorna um array, então pegamos o primeiro elemento
                customer = rpcData && rpcData.length > 0 ? rpcData[0] : null;
            }

            // Prepara os dados de insert ou update do cliente
            const customerInsertData = {
                restaurant_id: currentRestaurant?.id,
                name: orderData.customer_name,
                phone: orderData.customer_phone, // Salva o telefone formatado do formulário
                address: orderData.delivery_address,
                zip_code: orderData.zip_code,
                preferences: JSON.stringify(orderData.items.map(item => ({
                    item: item.name,
                    quantidade: item.quantity,
                    observacoes: item.notes,
                    valor_unitario: item.price.toFixed(2),
                    valor_total_item: (item.quantity * item.price).toFixed(2)
                }))),
                total_orders: (customer ? (customer.total_orders || 0) + 1 : 1),
                total_spent: (customer ? parseFloat(customer.total_spent || 0) + orderData.total_amount : orderData.total_amount)
            };

            // Salva ou atualiza o cliente
            if (customer) {
                const { error: updateError } = await supabase
                    .from('customers')
                    .update(customerInsertData)
                    .eq('id', customer.id);
                if (updateError) throw updateError;
            } else {
                const { error: insertError } = await supabase
                    .from('customers')
                    .insert([customerInsertData]);
                if (insertError) throw insertError;
            }

            let orderInsertData = {
                restaurant_id: currentRestaurant?.id || '50b2dbcb-66bb-4969-92cf-493f03237e49',
                subtotal: orderData.subtotal,
                total: orderData.total_amount,
                notes: orderData.notes?.trim() || null,
                order_balcao: null,
                order_mesa: null
            };

            if (orderData.payment_method && orderData.payment_method.trim() !== '') {
                orderInsertData.payment_method = orderData.payment_method;
            }

            switch (this.currentOrderMode) {
                case 'delivery':
                    Object.assign(orderInsertData, {
                        customer_name: orderData.customer_name.trim(),
                        customer_phone: orderData.customer_phone.trim(),
                        delivery_address: orderData.delivery_address.trim(),
                        delivery_fee: parseFloat(orderData.delivery_fee) || 0,
                        status: 'preparo'
                    });
                    break;
                case 'balcao':
                    Object.assign(orderInsertData, {
                        customer_name: orderData.customer_name?.trim() || 'Cliente de Balcão',
                        customer_phone: orderData.customer_phone?.trim() || 'N/A',
                        delivery_address: 'Balcão',
                        delivery_fee: 0,
                        status: 'preparo'
                    });
                    break;
                case 'mesa':
                    Object.assign(orderInsertData, {
                        customer_name: orderData.customer_name || `Mesa ${orderData.mesa_number}`,
                        customer_phone: 'N/A',
                        delivery_address: `Mesa ${orderData.mesa_number}`,
                        delivery_fee: 0,
                        status: 'Aberta'
                    });
                    break;
            }

            const { data: order, error: orderError } = await supabase
                .from('orders')
                .insert([orderInsertData])
                .select()
                .single();

            if (orderError) throw orderError;

            const orderItems = orderData.items.map(item => ({
                order_id: order.id,
                product_id: item.productId || null,
                product_name: item.name.trim(),
                quantity: parseInt(item.quantity),
                price: parseFloat(item.price),
                notes: item.notes?.trim() || null
            }));

            const { error: itemsError } = await supabase
                .from('order_items')
                .insert(orderItems);

            if (itemsError) {
                await supabase.from('orders').delete().eq('id', order.id);
                throw itemsError;
            }

            this.showNotification('Pedido criado com sucesso!', 'success');
            await this.loadOrders();
        } catch (error) {
            console.error('❌ Erro ao salvar pedido:', error);
            this.showNotification('Erro ao criar pedido: ' + error.message, 'error');
        }
    }

    openOrderDetails(orderId) {
        const order = this.orders.find(o => o.id === orderId);
        if (!order) return;

        const modal = document.getElementById('orderDetailsModal');
        const title = document.getElementById('orderDetailsTitle');
        const body = document.getElementById('orderDetailsBody');
        const actions = document.getElementById('orderDetailsActions');

        if (!modal || !title || !body || !actions) return;

        title.textContent = `Pedido #${order.order_number}`;

        body.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div>
                        <h4 style="color: var(--primary-color); margin-bottom: 1rem;">Dados do Cliente</h4>
                        <p><strong>Nome:</strong> ${order.customer_name || 'N/A'}</p>
                        <p><strong>Telefone:</strong> ${order.customer_phone || 'N/A'}</p>
                        <p><strong>Endereço:</strong> ${order.delivery_address || 'N/A'}</p>
                        ${order.notes ? `<p><strong>Observações:</strong> ${order.notes}</p>` : ''}
                    </div>
                    <div>
                        <h4 style="color: var(--primary-color); margin-bottom: 1rem;">Informações do Pedido</h4>
                        <p><strong>Status:</strong> <span class="order-status-badge ${order.status}">${this.getStatusLabel(order.status)}</span></p>
                        <p><strong>Pagamento:</strong> ${this.getPaymentMethodLabel(order.payment_method)}</p>
                        <p><strong>Criado em:</strong> ${new Date(order.created_at).toLocaleString('pt-BR')}</p>
                    </div>
                </div>

                <div style="margin-top: 2rem;">
                    <h4 style="color: var(--primary-color); margin-bottom: 1rem;">Itens do Pedido</h4>
                    <table class="items-table">
                        <thead>
                            <tr><th>Item</th><th>Qtd</th><th>Preço</th><th>Total</th></tr>
                        </thead>
                        <tbody>
                            ${order.order_items.map(item => `
                                <tr>
                                    <td>
                                        <div class="item-name-cell">${item.product_name}</div>
                                        ${item.notes ? `<div class="item-notes-cell">${item.notes}</div>` : ''}
                                    </td>
                                    <td class="item-quantity-cell">${item.quantity}</td>
                                    <td class="item-price-cell">R$ ${parseFloat(item.price).toFixed(2).replace('.', ',')}</td>
                                    <td class="item-total-cell">R$ ${(item.quantity * parseFloat(item.price)).toFixed(2).replace('.', ',')}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <div style="margin-top: 1rem; text-align: right;">
                        <p><strong>Subtotal:</strong> R$ ${parseFloat(order.subtotal || 0).toFixed(2).replace('.', ',')}</p>
                        <p><strong>Taxa de Entrega:</strong> R$ ${parseFloat(order.delivery_fee || 0).toFixed(2).replace('.', ',')}</p>
                        <p style="font-size: 1.2rem;"><strong>Total:</strong> R$ ${parseFloat(order.total || order.total_amount || 0).toFixed(2).replace('.', ',')}</p>
                    </div>
                </div>
            `;

        actions.innerHTML = `
                <button type="button" class="btn btn-outline" onclick="ordersManager.closeOrderDetailsModal()">Fechar</button>
                <div style="display: flex; gap: 0.5rem;">
                    ${this.getOrderDetailActions(order)}
                </div>
            `;

        modal.classList.add('show');
    }

    closeOrderDetailsModal() {
        const modal = document.getElementById('orderDetailsModal');
        if (modal) {
            modal.classList.remove('show');
        }
    }

    getOrderDetailActions(order) {
        const actions = [];
        const orderSector = getOrderSector(order);

        switch (order.status) {
            case 'novo':
                actions.push(`<button class="btn btn-success" onclick="ordersManager.updateOrderStatusFromDetails('${order.id}', 'aceito')"><i class="fas fa-check"></i> Aceitar</button>`);
                actions.push(`<button class="btn btn-danger" onclick="ordersManager.updateOrderStatusFromDetails('${order.id}', 'rejeitado')"><i class="fas fa-times"></i> Rejeitar</button>`);
                break;
            case 'aceito':
                actions.push(`<button class="btn btn-primary" onclick="ordersManager.updateOrderStatusFromDetails('${order.id}', 'preparo')"><i class="fas fa-utensils"></i> Iniciar Preparo</button>`);
                break;
            case 'preparo':
                actions.push(`<button class="btn btn-success" onclick="ordersManager.updateOrderStatusFromDetails('${order.id}', 'pronto')"><i class="fas fa-check-circle"></i> Marcar como Pronto</button>`);
                break;
            case 'pronto':
                if (orderSector === 'delivery') {
                    actions.push(`<button class="btn btn-primary" onclick="openDelivererSelectionModal('${order.id}')"><i class="fas fa-motorcycle"></i> Enviar p/ Entrega</button>`);
                } else {
                    actions.push(`<button class="btn btn-success" onclick="ordersManager.updateOrderStatusFromDetails('${order.id}', 'entregue')"><i class="fas fa-check-double"></i> Finalizar Retirada</button>`);
                }
                break;
            case 'saiu_entrega':
                actions.push(`<button class="btn btn-success" onclick="openPaymentMethodModal('${order.id}')"><i class="fas fa-flag-checkered"></i> Finalizar Entrega</button>`);
                break;
            case 'Aberta':
                actions.push(`<button class="btn btn-primary" onclick="openFinalizarMesaModal('${order.id}')"><i class="fas fa-dollar-sign"></i> Finalizar Mesa</button>`);
                break;
        }

        if (!['saiu_entrega', 'entregue', 'cancelado', 'rejeitado', 'encerrado'].includes(order.status)) {
            actions.push(`<button class="btn btn-danger" onclick="ordersManager.updateOrderStatusFromDetails('${order.id}', 'cancelado')"><i class="fas fa-ban"></i> Cancelar</button>`);
        }

        return actions.join('');
    }

    getStatusClass(status) {
        const classes = {
            'novo': 'novo',
            'aceito': 'aceito',
            'preparo': 'preparo',
            'pronto': 'pronto',
            'saiu_entrega': 'saiu_entrega',
            'entregue': 'entregue',
            'rejeitado': 'rejeitado',
            'cancelado': 'cancelado',
            'Aberta': 'Aberta',
            'encerrado': 'encerrado'
        };
        return classes[status] || 'novo';
    }

    getStatusLabel(status) {
        const labels = {
            'novo': 'Novo',
            'aceito': 'Aceito',
            'preparo': 'Em Preparo',
            'pronto': 'Pronto',
            'saiu_entrega': 'Saiu p/ Entrega',
            'entregue': 'Entregue',
            'rejeitado': 'Rejeitado',
            'cancelado': 'Cancelado',
            'Aberta': 'Aberta (Mesa)',
            'encerrado': 'Encerrado'
        };
        return labels[status] || status;
    }

    getPaymentMethodLabel(method) {
        const labels = {
            'money': 'Dinheiro',
            'card': 'Cartão',
            'pix': 'PIX',
            'voucher': 'Vale'
        };
        return labels[method] || (method ? method : 'Não informado');
    }

    getTimeAgo(dateString) {
        const now = new Date();
        const date = new Date(dateString);
        const diffInMinutes = Math.floor((now - date) / (1000 * 60));

        if (diffInMinutes < 1) return 'Agora';
        if (diffInMinutes < 60) return `${diffInMinutes}min atrás`;

        const diffInHours = Math.floor(diffInMinutes / 60);
        if (diffInHours < 24) return `${diffInHours}h atrás`;

        const diffInDays = Math.floor(diffInHours / 24);
        return `${diffInDays}d atrás`;
    }

    setupEventListeners() {
        const statusFilter = document.getElementById('statusFilter');
        const searchInput = document.getElementById('searchInput');
        const dateFilter = document.getElementById('dateFilter');
        const phoneInput = document.getElementById('deliveryCustomerPhone');

        if (statusFilter) {
            statusFilter.addEventListener('change', () => this.applyFilters());
        }
        if (searchInput) {
            searchInput.addEventListener('input', () => this.applyFilters());
        }
        if (dateFilter) {
            dateFilter.addEventListener('change', () => this.applyFilters());
        }

        // Event listener para o campo de telefone no modal de delivery
        if (phoneInput) {
            phoneInput.addEventListener('blur', async (e) => {
                // A limpeza do telefone é feita aqui para garantir que mesmo
                // uma entrada sem formatação seja tratada corretamente.
                const phone = e.target.value.trim().replace(/\D/g, '');
                if (phone.length >= 10) {
                    await this.checkCustomerByPhone(phone);
                }
            });
        }

        // Event listener para a busca direta por produtos
        document.querySelectorAll('#deliveryProductSearch, #balcaoProductSearch, #mesaProductSearch').forEach(input => {
            input.addEventListener('input', (e) => {
                this.performProductSearch(e.target.value.trim(), input.id.replace('ProductSearch', ''));
            });
        });

        // Clica fora para fechar os resultados
        document.addEventListener('click', (e) => {
            document.querySelectorAll('.search-results').forEach(results => {
                if (!e.target.closest('.product-search-container')) {
                    results.style.display = 'none';
                }
            });
        });

        const deliveryFeeInput = document.getElementById('deliveryFee');
        if (deliveryFeeInput) {
            deliveryFeeInput.addEventListener('input', () => {
                this.updateDeliveryOrderDisplays();
            });
        }

        const mesaServiceFeeCheckbox = document.getElementById('mesaServiceFee');
        if (mesaServiceFeeCheckbox) {
            mesaServiceFeeCheckbox.addEventListener('change', () => {
                this.updateMesaOrderDisplays();
            });
        }

        // Event Listeners for Delivery Route Calculation
        document.querySelectorAll('#deliveryCep, #deliveryNumber, #deliveryComplement').forEach(element => {
            element.addEventListener('blur', () => {
                clearTimeout(routeCalculationTimeout);
                routeCalculationTimeout = setTimeout(() => {
                    calculateDeliveryRoute();
                }, 500); // Debounce de 500ms
            });
            element.addEventListener('input', () => {
                // Junta os campos para formar o endereço completo
                const rua = document.getElementById('deliveryRua')?.value.trim() || '';
                const numero = document.getElementById('deliveryNumber')?.value.trim() || '';
                const complemento = document.getElementById('deliveryComplement')?.value.trim() || '';
                const bairro = document.getElementById('deliveryBairro')?.value.trim() || '';
                const cidade = document.getElementById('deliveryCidade')?.value.trim() || '';
                const uf = document.getElementById('deliveryUf')?.value.trim() || '';

                let enderecoCompleto = `${rua}`;
                if (numero) enderecoCompleto += `, ${numero}`;
                if (complemento) enderecoCompleto += `, ${complemento}`;
                if (bairro) enderecoCompleto += `, ${bairro}`;
                if (cidade) enderecoCompleto += `, ${cidade}`;
                if (uf) enderecoCompleto += ` - ${uf}`;

                document.getElementById('deliveryAddress').value = enderecoCompleto.replace(/,(\s*,){1,}/g, ',').replace(/(^\s*,)|(,\s*$)/g, '');
            });
        });

        const deliveryRoundtripCheckbox = document.getElementById('deliveryIncludeRoundtrip');
        if (deliveryRoundtripCheckbox) {
            deliveryRoundtripCheckbox.addEventListener('change', () => {
                calculateDeliveryRoute();
            });
        }
    }

    // CORRIGIDO: Esta função agora usa a função RPC 'get_customer_by_phone' para uma busca robusta.
    async checkCustomerByPhone(phone) {
        try {
            // A 'phone' que chega aqui já está limpa (só dígitos) pelo event listener.
            const { data: rpcData, error } = await supabase
                .rpc('get_customer_by_phone', {
                    p_phone_number: phone,
                    p_restaurant_id: currentRestaurant?.id
                });

            if (error) {
                // Ignora o erro se for apenas "nenhuma linha encontrada"
                if (error.code !== 'PGRST116' && !error.message.includes('Result with 0 rows was returned')) {
                    throw error;
                }
            }
            
            // O RPC retorna um array, então pegamos o primeiro elemento
            const customer = rpcData && rpcData.length > 0 ? rpcData[0] : null;

            if (customer) {
                // Cliente encontrado, preenche os campos
                ordersManager.showNotification('Dados do cliente carregados!', 'success');
                document.getElementById('deliveryCustomerName').value = customer.name || '';
                document.getElementById('deliveryAddress').value = customer.address || '';
                document.getElementById('deliveryCep').value = customer.zip_code || '';

                // Tenta preencher os campos de endereço separados a partir do campo 'address'
                if (customer.address) {
                    const addressParts = customer.address.split(',').map(p => p.trim());
                    document.getElementById('deliveryRua').value = addressParts[0] || '';
                    document.getElementById('deliveryNumber').value = addressParts[1] || '';
                    document.getElementById('deliveryBairro').value = addressParts[2] || '';
                    document.getElementById('deliveryCidade').value = addressParts[3] || '';
                    document.getElementById('deliveryUf').value = addressParts[4] || '';
                    document.getElementById('deliveryComplement').value = ''; // Não há dados de complemento no exemplo
                }

                // Dispara o cálculo da rota
                calculateDeliveryRoute();
            } else {
                // Cliente não encontrado, avisa o usuário e limpa os campos de endereço
                ordersManager.showNotification('Cliente não encontrado. Preencha os dados manualmente.', 'info');
                document.getElementById('deliveryCustomerName').value = '';
                // Não limpa o telefone, pois foi o que o usuário digitou
                limpa_formulário_cep('delivery');
            }
        } catch (error) {
            console.error('❌ Erro ao buscar cliente por telefone:', error);
            ordersManager.showNotification('Erro ao buscar cliente.', 'error');
        }
    }

    setupRealtimeUpdates() {
        console.log('📡 Setup de updates em tempo real configurado');
        if (!currentRestaurant) return;

        if (realtimeSubscription) {
            supabase.removeChannel(realtimeSubscription);
        }

        const restaurantId = localStorage.getItem('restaurant_id');
        if (!restaurantId) return;

        realtimeSubscription = supabase
            .channel('orders-updates')
            .on(
                'postgres_changes',
                { event: '*', schema: 'public', table: 'orders', filter: `restaurant_id=eq.${restaurantId}` },
                (payload) => {
                    console.log('🔄 Mudança em tempo real recebida!', payload);
                    // Adiciona o novo ID à lista de IDs já exibidos para evitar reabrir o modal
                    if (payload.eventType === 'INSERT' && payload.new.status === 'novo') {
                        this.shownNewOrderIds.add(payload.new.id);
                    }
                    this.loadOrders();
                }
            )
            .subscribe();
    }

    setupAutoRefresh() {
        this.updateInterval = setInterval(() => {
            this.loadOrders();
        }, 60000);
    }

    async updateOrderStatus(orderId, newStatus) {
        try {
            const { data, error } = await supabase
                .from('orders')
                .update({
                    status: newStatus,
                    updated_at: new Date().toISOString()
                })
                .eq('id', orderId)
                .select()
                .single();

            if (error) throw error;

            if (newStatus !== 'novo') {
                stopNewOrderSound(orderId);
                console.log(`🔇 Parando alerta sonoro para o pedido: #${this.orders.find(o => o.id === orderId)?.order_number}`);
            }

            this.showNotification(`Status atualizado para: ${this.getStatusLabel(newStatus)}`, 'success');
            await this.loadOrders();
        } catch (error) {
            console.error('❌ Erro ao atualizar status:', error);
            this.showNotification('Erro ao atualizar status', 'error');
        }
    }

    async updateOrderStatusFromDetails(orderId, newStatus) {
        await this.updateOrderStatus(orderId, newStatus);
        this.closeOrderDetailsModal();
    }

    showNotification(message, type = 'info') {
        const existingNotification = document.querySelector('.notification');
        if (existingNotification) {
            existingNotification.remove();
        }

        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.classList.add('show');
        }, 100);

        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 400);
        }, 3000);
    }

    async openDelivererSelectionModal(orderId) {
        if (!this) return;
        this.currentOrderForDelivery = orderId;

        const modal = document.getElementById('delivererSelectionModal');
        const select = document.getElementById('delivererSelect');
        const modalCloseButton = document.querySelector('#delivererSelectionModal .modal-close');
        const modalCancelButton = document.querySelector('#delivererSelectionModal .btn-secondary');

        if (!modal || !select || !modalCloseButton || !modalCancelButton) {
            console.error('Modal ou botões de entregadores não encontrados.');
            return;
        }

        // Limpa as opções existentes
        select.innerHTML = '<option value="">Carregando...</option>';
        modal.classList.add('show');

        // Adiciona event listeners aos botões de fechar e cancelar
        modalCloseButton.onclick = () => this.closeDelivererSelectionModal();
        modalCancelButton.onclick = () => this.closeDelivererSelectionModal();

        try {
            const deliverersData = await this.loadDeliverers();
            select.innerHTML = '<option value="">Selecione o entregador</option>';
            deliverersData.forEach(deliverer => {
                const option = document.createElement('option');
                option.value = deliverer.id;
                option.textContent = deliverer.name;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Erro ao carregar entregadores:', error);
            select.innerHTML = '<option value="">Erro ao carregar</option>';
        }
    }

    closeDelivererSelectionModal() {
        const modal = document.getElementById('delivererSelectionModal');
        if (modal) {
            modal.classList.remove('show');
        }
        this.currentOrderForDelivery = null;
    }

    async confirmDelivererSelection() {
        const delivererId = document.getElementById('delivererSelect')?.value;
        const orderId = this.currentOrderForDelivery;

        if (!orderId || !delivererId) {
            this.showNotification('Selecione um entregador para continuar.', 'warning');
            return;
        }

        try {
            // Atualiza a tabela de orders
            const { error: orderError } = await supabase
                .from('orders')
                .update({
                    status: 'saiu_entrega',
                    deliverer_id: delivererId,
                    updated_at: new Date().toISOString()
                })
                .eq('id', orderId);

            if (orderError) throw orderError;

            // **NOVO**: Atualiza a tabela de deliverers
            const { error: delivererError } = await supabase
                .from('deliverers')
                .update({
                    status: 'active',
                    id_pedido: null, // Limpa o ID do pedido
                    updated_at: new Date().toISOString()
                })
                .eq('id', delivererId);

            if (delivererError) throw delivererError;

            this.showNotification('Pedido enviado para entrega com sucesso!', 'success');
            await this.loadOrders();
            this.closeDelivererSelectionModal();
            this.closeOrderDetailsModal();
        } catch (error) {
            console.error('Erro ao confirmar seleção do entregador:', error);
            this.showNotification('Erro ao enviar para entrega. Tente novamente.', 'error');
        }
    }

    openPaymentMethodModal(orderId) {
        if (!this) return;
        this.currentOrderForPayment = orderId;
        const modal = document.getElementById('paymentMethodModal');
        const order = this.orders.find(o => o.id === orderId);

        if (!modal || !order) return;

        // Adicionando os event listeners para os botões de fechar
        const modalCloseButton = modal.querySelector('.modal-close');
        const modalCancelButton = modal.querySelector('.btn-secondary');

        if (modalCloseButton) {
            modalCloseButton.onclick = () => this.closePaymentMethodModal();
        }
        if (modalCancelButton) {
            modalCancelButton.onclick = () => this.closePaymentMethodModal();
        }

        const finalPaymentMethodSelect = document.getElementById('finalPaymentMethod');
        if (finalPaymentMethodSelect) {
            finalPaymentMethodSelect.value = order.payment_method || '';
            toggleFinalChangeFields();
        }
        modal.classList.add('show');
    }

    closePaymentMethodModal() {
        const modal = document.getElementById('paymentMethodModal');
        if (modal) {
            modal.classList.remove('show');
        }
        this.currentOrderForPayment = null;
    }

    async confirmPaymentAndFinish() {
        const paymentMethod = document.getElementById('finalPaymentMethod')?.value;
        const orderId = this.currentOrderForPayment;
        if (!orderId || !paymentMethod) {
            this.showNotification('Selecione a forma de pagamento.', 'warning');
            return;
        }

        try {
            // Atualiza a tabela de orders
            const { error: orderError } = await supabase
                .from('orders')
                .update({
                    status: 'entregue',
                    payment_method: paymentMethod,
                    updated_at: new Date().toISOString()
                })
                .eq('id', orderId);

            if (orderError) throw orderError;

            // **NOVO**: Atualiza a tabela de deliverers
            const { error: delivererError } = await supabase
                .from('deliverers')
                .update({
                    status: 'active',
                    id_pedido: null, // Limpa o ID do pedido
                    updated_at: new Date().toISOString()
                })
                .eq('id_pedido', orderId); // Busca pelo ID do pedido

            if (delivererError) throw delivererError;

            this.showNotification('Entrega finalizada com sucesso!', 'success');
            await this.loadOrders();
            this.closePaymentMethodModal();
            this.closeOrderDetailsModal();
        } catch (error) {
            console.error('Erro ao finalizar entrega:', error);
            this.showNotification('Erro ao finalizar entrega. Tente novamente.', 'error');
        }
    }
}

// FUNÇÕES DE ALERTA SONORO
function resumeAudioContext() {
    if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioContext.state === 'suspended') {
        audioContext.resume().then(() => {
            console.log('▶️ Contexto de áudio retomado por interação do usuário.');
            audioContextResumed = true;
        });
    } else {
        audioContextResumed = true;
    }
}

function playNewOrderSound() {
    resumeAudioContext();

    if (!audioContextResumed) {
        console.warn('⚠️ AudioContext ainda não está pronto. O som será tocado na próxima interação.');
        return;
    }

    if (newOrderOscillator) {
        newOrderOscillator.stop();
        newOrderOscillator.disconnect();
    }

    newOrderOscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();

    newOrderOscillator.type = 'sine';
    newOrderOscillator.frequency.setValueAtTime(440, audioContext.currentTime); // A4
    gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);

    newOrderOscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);

    newOrderOscillator.start();
    setTimeout(() => {
        if (newOrderOscillator) {
            newOrderOscillator.stop();
        }
    }, 500); // Toca por 0.5 segundos
}


function playNewOrderSoundLoop() {
    playNewOrderSound();
    return setInterval(() => {
        playNewOrderSound();
    }, 3000); // Toca o som a cada 3 segundos
}

function stopNewOrderSound(orderId) {
    if (soundIntervals[orderId]) {
        clearInterval(soundIntervals[orderId]);
        delete soundIntervals[orderId];
        // Se não houver mais pedidos com o alerta, para o oscilador global
        if (Object.keys(soundIntervals).length === 0) {
            if (newOrderOscillator) {
                newOrderOscillator.stop();
                newOrderOscillator.disconnect();
                newOrderOscillator = null;
            }
        }
    }
}

// ===== FUNÇÃO DE INICIALIZAÇÃO PRINCIPAL =====
async function checkAuthenticationAndLoadConfig() {
    console.log('Verificando status de autenticação...');
    const restaurantId = localStorage.getItem('restaurant_id');
    const { data: { session } } = await supabase.auth.getSession();

    // Se não houver sessão ou ID de restaurante, redireciona.
    if (!session || !restaurantId) {
        console.log('Usuário não autenticado ou sem restaurant_id. Redirecionando para login...');
        window.location.href = 'login.html';
        return;
    }

    console.log('✅ Usuário autenticado e restaurant_id encontrado:', restaurantId);

    // Se a autenticação estiver correta, inicia o OrdersManager.
    try {
        ordersManager = new OrdersManager();
        await ordersManager.init();
        console.log('✅ Aplicação iniciada com sucesso!');
    } catch (error) {
        console.error('Falha na inicialização da aplicação após a autenticação.', error);
        document.body.innerHTML = `
            <div style="display: flex; justify-content: center; align-items: center; height: 100vh; text-align: center;">
                <div>
                    <h2>Erro na Inicialização</h2>
                    <p>${error.message}</p>
                    <button onclick="window.location.reload()" class="btn btn-primary">Recarregar</button>
                </div>
            </div>
        `;
    }
}

// ===== FUNÇÕES PARA ADICIONAIS =====
async function handleProductSelection(product, context) {
    try {
        const { data: links, error: linkError } = await supabase
            .from('product_add_on_categories_link')
            .select('add_on_category_id')
            .eq('product_id', product.id);

        if (linkError) throw linkError;

        if (!links || links.length === 0) {
            addProductItemToOrder([], product, context);
            return;
        }

        await openAddOnsModal(product, links.map(l => l.add_on_category_id), context);
    } catch (error) {
        console.error('❌ Erro ao verificar adicionais do produto:', error);
        if (ordersManager) ordersManager.showNotification('Erro ao carregar adicionais do produto.', 'error');
    }
}

async function openAddOnsModal(product, categoryIds, context) {
    currentProductForAddOns = product;
    currentOrderContextForAddOns = context;

    const modal = document.getElementById('addOnsModal');
    const title = document.getElementById('addOnsModalTitle');
    const loading = document.getElementById('addOnsLoading');
    const content = document.getElementById('addOnsContent');

    if (!modal || !title || !loading || !content) return;

    title.textContent = `Adicionais para: ${product.name}`;
    loading.style.display = 'block';
    content.style.display = 'none';
    content.innerHTML = '';
    modal.classList.add('show');

    try {
        const { data: categories, error: catError } = await supabase
            .from('add_on_categories')
            .select('*')
            .in('id', categoryIds);

        if (catError) throw catError;

        const { data: addOns, error: addOnError } = await supabase
            .from('product_add_ons')
            .select('*')
            .in('add_on_category_id', categoryIds)
            .eq('active', true)
            .order('name');

        if (addOnError) throw addOnError;

        let html = '';
        for (const category of categories) {
            const itemsInCategory = addOns.filter(item => item.add_on_category_id === category.id);
            if (itemsInCategory.length === 0) continue;

            const inputType = category.selection_type === 'single' ? 'radio' : 'checkbox';

            html += `
                    <div class="form-section">
                        <h4>${category.name} ${category.min_selection > 0 ? '*' : ''}</h4>
                        ${category.description ? `<p class="form-text text-muted">${category.description}</p>` : ''}
                        <div class="add-ons-group" data-category-id="${category.id}" data-min="${category.min_selection || 0}" data-max="${category.max_selection || itemsInCategory.length}">
                            ${itemsInCategory.map(item => `
                                <div class="add-on-item">
                                    <input type="${inputType}" id="addon_${item.id}" name="addon_cat_${category.id}" value="${item.id}" data-price="${item.price}" data-name="${item.name}">
                                    <label for="addon_${item.id}">
                                        <span class="add-on-name">${item.name}</span>
                                        <span class="add-on-price">+ R$ ${parseFloat(item.price).toFixed(2).replace('.', ',')}</span>
                                    </label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
        }
        content.innerHTML = html;
        loading.style.display = 'none';
        content.style.display = 'block';
    } catch (error) {
        console.error('❌ Erro ao popular modal de adicionais:', error);
        loading.innerHTML = '<p class="text-danger">Não foi possível carregar os adicionais.</p>';
    }
}

function closeAddOnsModal() {
    const modal = document.getElementById('addOnsModal');
    if (modal) {
        modal.classList.remove('show');
    }
    currentProductForAddOns = null;
    currentOrderContextForAddOns = null;
}

function confirmAddOnsSelection() {
    const selectedAddOns = [];
    let validationError = false;

    document.querySelectorAll('.add-ons-group').forEach(group => {
        const min = parseInt(group.dataset.min);
        const max = parseInt(group.dataset.max);
        const selectedCount = group.querySelectorAll('input:checked').length;
        const categoryName = group.previousElementSibling.textContent;

        if (selectedCount < min) {
            if (ordersManager) ordersManager.showNotification(`Selecione pelo menos ${min} item(ns) em "${categoryName}".`, 'warning');
            validationError = true;
        }
        if (selectedCount > max) {
            if (ordersManager) ordersManager.showNotification(`Selecione no máximo ${max} item(ns) em "${categoryName}".`, 'warning');
            validationError = true;
        }
    });

    if (validationError) return;

    document.querySelectorAll('#addOnsModalBody input:checked').forEach(input => {
        selectedAddOns.push({
            id: input.value,
            name: input.dataset.name,
            price: parseFloat(input.dataset.price)
        });
    });

    addProductItemToOrder(selectedAddOns, currentProductForAddOns, currentOrderContextForAddOns);
    closeAddOnsModal();
}

function addProductItemToOrder(selectedAddOns, product, context) {
    if (!product || !context || !ordersManager) return;

    let totalItemPrice = parseFloat(product.price);
    let notes = selectedAddOns.map(addOn => `+ ${addOn.name}`).join('\n');

    selectedAddOns.forEach(addOn => {
        totalItemPrice += addOn.price;
    });

    const newItem = {
        productId: product.id,
        name: product.name,
        price: totalItemPrice,
        quantity: 1,
        notes: notes,
        selected_add_ons: selectedAddOns.map(a => ({ id: a.id, name: a.name, price: a.price })),
        base_price: parseFloat(product.price)
    };

    ordersManager.newOrderItems.push(newItem);

    switch (context) {
        case 'delivery':
            ordersManager.renderDeliveryOrderItems();
            ordersManager.updateDeliveryOrderDisplays();
            break;
        case 'balcao':
            ordersManager.renderBalcaoOrderItems();
            ordersManager.updateBalcaoOrderDisplays();
            break;
        case 'mesa':
            ordersManager.renderMesaOrderItems();
            ordersManager.updateMesaOrderDisplays();
            break;
    }

    if (ordersManager) ordersManager.showNotification(`${product.name} adicionado ao pedido.`, 'success');
    // Fechando o modal de seleção de produtos e mantendo o modal principal
    closeProductSelectionModal();
}

// ===== FUNÇÕES DO SISTEMA =====
function filterBySector(sector) {
    currentSectorFilter = sector;
    document.querySelectorAll('.sector-filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    const selectedBtn = document.querySelector(`[data-sector="${sector}"]`);
    if (selectedBtn) {
        selectedBtn.classList.add('active');
    }
    if (ordersManager) {
        ordersManager.applyFilters();
    }
}

function getOrderSector(order) {
    if (order.delivery_address === 'Balcão') {
        return 'balcao';
    } else if (order.delivery_address && order.delivery_address.startsWith('Mesa ')) {
        return 'mesa';
    } else if (order.delivery_fee > 0 || (order.delivery_address && order.delivery_address !== 'Balcão' && !order.delivery_address.startsWith('Mesa '))) {
        return 'delivery';
    } else {
        return order.delivery_fee > 0 ? 'delivery' : 'balcao';
    }
}

function updateOnlineToggleUI() {
    const toggle = document.getElementById('onlineToggle');
    const icon = document.getElementById('onlineIcon');
    const text = document.getElementById('onlineText');

    if (!toggle || !icon || !text) return;

    if (isOnline) {
        toggle.className = 'online-toggle online';
        icon.className = 'fas fa-circle';
        text.textContent = 'Online';
    } else {
        toggle.className = 'online-toggle offline';
        icon.className = 'fas fa-circle';
        text.textContent = 'Offline';
    }
}

async function toggleOnlineStatus() {
    try {
        const newStatus = !isOnline;
        const restaurantId = localStorage.getItem('restaurant_id');
        if (!restaurantId) {
            throw new Error('ID do restaurante não encontrado.');
        }

        const { data, error } = await supabase
            .from('restaurants')
            .update({
                pedidos_online: newStatus,
                updated_at: new Date().toISOString()
            })
            .eq('id', restaurantId)
            .select()
            .single();

        if (error) throw error;

        isOnline = newStatus;
        currentRestaurant.pedidos_online = newStatus;
        updateOnlineToggleUI();

        const statusText = newStatus ? 'Online' : 'Offline';
        const statusColor = newStatus ? 'success' : 'warning';

        if (ordersManager) {
            ordersManager.showNotification(`Status alterado para: ${statusText}`, statusColor);
        }
    } catch (error) {
        console.error('❌ Erro ao alterar status online:', error);
        if (ordersManager) {
            ordersManager.showNotification('Erro ao alterar status online', 'error');
        }
    }
}

function toggleFullscreen() {
    const body = document.body;
    const fullscreenIcon = document.getElementById('fullscreenIcon');
    const fullscreenText = document.getElementById('fullscreenText');

    if (!isFullscreenMode) {
        body.classList.add('fullscreen-mode');
        isFullscreenMode = true;
        if (fullscreenIcon) fullscreenIcon.className = 'fas fa-compress';
        if (fullscreenText) fullscreenText.textContent = 'Sair da Tela Cheia';
    } else {
        body.classList.remove('fullscreen-mode');
        isFullscreenMode = false;
        if (fullscreenIcon) fullscreenIcon.className = 'fas fa-expand';
        if (fullscreenText) fullscreenText.textContent = 'Tela Cheia';
    }
}

// ===== FUNÇÕES DE MODAL =====
function openOrderTypeSelectionModal() {
    const modal = document.getElementById('orderTypeSelectionModal');
    if (modal) {
        modal.classList.add('show');
    }
}

function closeOrderTypeSelectionModal() {
    const modal = document.getElementById('orderTypeSelectionModal');
    if (modal) {
        modal.classList.remove('show');
    }
}

function selectOrderType(type) {
    closeOrderTypeSelectionModal();
    if (!ordersManager) return;

    ordersManager.currentOrderMode = type;
    ordersManager.currentOrderContext = type;
    ordersManager.newOrderItems = [];

    switch (type) {
        case 'delivery':
            openDeliveryOrderModal();
            break;
        case 'balcao':
            openBalcaoOrderModal();
            break;
        case 'mesa':
            openMesaOrderModal();
            break;
    }
}

function openDeliveryOrderModal() {
    const modal = document.getElementById('deliveryOrderModal');
    if (modal && ordersManager) {
        ordersManager.newOrderItems = [];
        const form = document.getElementById('deliveryOrderForm');
        if (form) {
            form.reset();
        }
        ordersManager.renderDeliveryOrderItems();
        modal.classList.add('show');
    }
}

function closeDeliveryOrderModal() {
    const modal = document.getElementById('deliveryOrderModal');
    if (modal) {
        modal.classList.remove('show');
    }
    const form = document.getElementById('deliveryOrderForm');
    if (form) {
        form.reset();
    }
    if (ordersManager) {
        ordersManager.newOrderItems = [];
        ordersManager.renderDeliveryOrderItems();
    }
}

function openBalcaoOrderModal() {
    const modal = document.getElementById('balcaoOrderModal');
    if (modal && ordersManager) {
        ordersManager.newOrderItems = [];
        const form = document.getElementById('balcaoOrderForm');
        if (form) {
            form.reset();
        }
        ordersManager.renderBalcaoOrderItems();
        modal.classList.add('show');
    }
}

function closeBalcaoOrderModal() {
    const modal = document.getElementById('balcaoOrderModal');
    if (modal) {
        modal.classList.remove('show');
    }
    const form = document.getElementById('balcaoOrderForm');
    if (form) {
        form.reset();
    }
    if (ordersManager) {
        ordersManager.newOrderItems = [];
        ordersManager.renderBalcaoOrderItems();
    }
}

function openMesaOrderModal() {
    const modal = document.getElementById('mesaOrderModal');
    if (modal && ordersManager) {
        ordersManager.newOrderItems = [];
        const form = document.getElementById('mesaOrderForm');
        if (form) {
            form.reset();
        }
        ordersManager.renderMesaOrderItems();
        modal.classList.add('show');
    }
}

function closeMesaOrderModal() {
    const modal = document.getElementById('mesaOrderModal');
    if (modal) {
        modal.classList.remove('show');
    }
    const form = document.getElementById('mesaOrderForm');
    if (form) {
        form.reset();
    }
    if (ordersManager) {
        ordersManager.newOrderItems = [];
        ordersManager.renderMesaOrderItems();
    }
}

async function openProductSelectionModal(context) {
    if (!ordersManager) return;

    ordersManager.currentOrderContext = context;
    ordersManager.isNewOrderContext = true;

    const modal = document.getElementById('productSelectionModal');
    const productCategoriesContainer = document.getElementById('productCategories');

    if (!modal || !productCategoriesContainer) return;

    const productsGroupedByCategory = ordersManager.products.reduce((acc, product) => {
        const categoryName = product.product_categories?.name || 'Sem Categoria';
        if (!acc[categoryName]) {
            acc[categoryName] = [];
        }
        acc[categoryName].push(product);
        return acc;
    }, {});

    let htmlContent = '';
    for (const categoryName in productsGroupedByCategory) {
        const productsInCategory = productsGroupedByCategory[categoryName];
        htmlContent += `
                    <div class="form-section">
                        <h4>${categoryName}</h4>
                        <div class="product-list-container">
                            ${productsInCategory.map(product => {
            const last4Digits = product.id.slice(-4).toUpperCase();
            const productJsonString = JSON.stringify(product).replace(/"/g, '&quot;');
            return `
                                <div class="product-list-item" onclick="handleProductSelection(${productJsonString}, '${context}')">
                                    <div class="product-list-item-header">
                                        <span class="product-name">${last4Digits} - ${product.name}</span>
                                        <span class="product-price">R$ ${parseFloat(product.price).toFixed(2).replace('.', ',')}</span>
                                    </div>
                                    <div class="product-list-item-description">
                                        ${product.description || 'Nenhuma descrição disponível.'}
                                    </div>
                                </div>
                                `;
        }).join('')}
                        </div>
                    </div>
                `;
    }
    productCategoriesContainer.innerHTML = htmlContent;

    modal.classList.add('show');
}

function closeProductSelectionModal() {
    const modal = document.getElementById('productSelectionModal');
    if (modal) {
        modal.classList.remove('show');
    }
}

// ===== FUNÇÕES DE SUBMISSÃO DE PEDIDOS =====
async function submitDeliveryOrder() {
    if (!ordersManager) return;

    const customerName = document.getElementById('deliveryCustomerName')?.value.trim();
    const customerPhone = document.getElementById('deliveryCustomerPhone')?.value.trim();

    const rua = document.getElementById('deliveryRua')?.value.trim();
    const numero = document.getElementById('deliveryNumber')?.value.trim();
    const complemento = document.getElementById('deliveryComplement')?.value.trim();
    const bairro = document.getElementById('deliveryBairro')?.value.trim();
    const cidade = document.getElementById('deliveryCidade')?.value.trim();
    const uf = document.getElementById('deliveryUf')?.value.trim();
    const zipCode = document.getElementById('deliveryCep')?.value.trim();

    let deliveryAddress = '';
    if (rua) {
        deliveryAddress = rua;
        if (numero) deliveryAddress += `, ${numero}`;
        if (complemento) deliveryAddress += `, ${complemento}`;
        if (bairro) deliveryAddress += `, ${bairro}`;
        if (cidade) deliveryAddress += `, ${cidade}`;
        if (uf) deliveryAddress += ` - ${uf}`;
    } else {
        deliveryAddress = document.getElementById('deliveryAddress')?.value.trim();
    }

    const paymentMethod = document.getElementById('deliveryPaymentMethod')?.value;
    const deliveryFee = parseFloat(document.getElementById('deliveryFee')?.value) || 0;
    const notes = document.getElementById('deliveryOrderNotes')?.value.trim();

    if (!customerName || !customerPhone || !deliveryAddress || !paymentMethod) {
        if (ordersManager) ordersManager.showNotification('Preencha todos os campos obrigatórios', 'warning');
        return;
    }

    if (ordersManager.newOrderItems.length === 0) {
        if (ordersManager) ordersManager.showNotification('Adicione pelo menos um item ao pedido', 'warning');
        return;
    }

    const subtotal = ordersManager.newOrderItems.reduce((sum, item) => sum + (item.quantity * item.price), 0);
    const totalAmount = subtotal + deliveryFee;

    const orderData = {
        customer_name: customerName,
        customer_phone: customerPhone,
        delivery_address: deliveryAddress,
        zip_code: zipCode,
        delivery_fee: deliveryFee,
        payment_method: paymentMethod,
        notes: notes,
        subtotal: subtotal,
        total_amount: totalAmount,
        items: [...ordersManager.newOrderItems]
    };

    if (ordersManager) await ordersManager.saveOrder(orderData);
    closeDeliveryOrderModal();
}

function submitBalcaoOrder() {
    if (!ordersManager) return;

    const customerName = document.getElementById('balcaoCustomerName')?.value.trim() || 'Cliente de Balcão';
    const customerPhone = document.getElementById('balcaoCustomerPhone')?.value.trim() || 'N/A';
    const paymentMethod = document.getElementById('balcaoPaymentMethod')?.value;
    const notes = document.getElementById('balcaoOrderNotes')?.value.trim();

    if (!paymentMethod) {
        if (ordersManager) ordersManager.showNotification('Selecione a forma de pagamento', 'warning');
        return;
    }

    if (ordersManager.newOrderItems.length === 0) {
        if (ordersManager) ordersManager.showNotification('Adicione pelo menos um item ao pedido', 'warning');
        return;
    }

    const subtotal = ordersManager.newOrderItems.reduce((sum, item) => sum + (item.quantity * item.price), 0);

    const orderData = {
        customer_name: customerName,
        customer_phone: customerPhone,
        delivery_address: 'Balcão',
        delivery_fee: 0,
        payment_method: paymentMethod,
        notes: notes,
        subtotal: subtotal,
        total_amount: subtotal,
        items: [...ordersManager.newOrderItems]
    };

    if (ordersManager) ordersManager.saveOrder(orderData);
    closeBalcaoOrderModal();
}

function submitMesaOrder() {
    if (!ordersManager) return;

    const mesaNumber = document.getElementById('mesaNumber')?.value.trim();
    const customerName = document.getElementById('mesaCustomerName')?.value.trim() || `Mesa ${mesaNumber}`;
    const paymentMethod = document.getElementById('mesaPaymentMethod')?.value || '';
    const notes = document.getElementById('mesaOrderNotes')?.value.trim();
    const subtotal = ordersManager.newOrderItems.reduce((sum, item) => sum + (item.quantity * item.price), 0);
    const serviceFeeCheckbox = document.getElementById('mesaServiceFee');
    const serviceFee = serviceFeeCheckbox && serviceFeeCheckbox.checked ? subtotal * 0.10 : 0;
    const totalAmount = subtotal + serviceFee;

    if (!mesaNumber) {
        if (ordersManager) ordersManager.showNotification('Selecione o número da mesa', 'warning');
        return;
    }

    if (ordersManager.newOrderItems.length === 0) {
        if (ordersManager) ordersManager.showNotification('Adicione pelo menos um item ao pedido', 'warning');
        return;
    }

    const orderData = {
        customer_name: customerName,
        mesa_number: mesaNumber,
        payment_method: paymentMethod,
        notes: notes,
        subtotal: subtotal,
        total_amount: totalAmount,
        items: [...ordersManager.newOrderItems]
    };

    if (ordersManager) ordersManager.saveOrder(orderData);
    closeMesaOrderModal();
}

// ===== FUNÇÕES PARA MANIPULAÇÃO DE ITENS =====
function updateDeliveryOrderItemQuantity(index, quantity) { if (ordersManager) ordersManager.updateNewOrderItemQuantity(index, quantity, 'delivery'); }
function updateDeliveryOrderItemPrice(index, price) { if (ordersManager) ordersManager.updateNewOrderItemPrice(index, price, 'delivery'); }
function editDeliveryOrderItemNotes(index) { if (ordersManager) ordersManager.editNewOrderItemNotes(index, 'delivery'); }
function removeDeliveryOrderItem(index) { if (ordersManager) ordersManager.removeNewOrderItem(index, 'delivery'); }
function updateBalcaoOrderItemQuantity(index, quantity) { if (ordersManager) ordersManager.updateNewOrderItemQuantity(index, quantity, 'balcao'); }
function updateBalcaoOrderItemPrice(index, price) { if (ordersManager) ordersManager.updateNewOrderItemPrice(index, price, 'balcao'); }
function editBalcaoOrderItemNotes(index) { if (ordersManager) ordersManager.editNewOrderItemNotes(index, 'balcao'); }
function removeBalcaoOrderItem(index) { if (ordersManager) ordersManager.removeNewOrderItem(index, 'balcao'); }
function updateMesaOrderItemQuantity(index, quantity) { if (ordersManager) ordersManager.updateNewOrderItemQuantity(index, quantity, 'mesa'); }
function updateMesaOrderItemPrice(index, price) { if (ordersManager) ordersManager.updateNewOrderItemPrice(index, price, 'mesa'); }
function editMesaOrderItemNotes(index) { if (ordersManager) ordersManager.editNewOrderItemNotes(index, 'mesa'); }
function removeMesaOrderItem(index) { if (ordersManager) ordersManager.removeNewOrderItem(index, 'mesa'); }

// ===== FUNÇÕES DE FILTROS E AÇÕES =====
function applyFilters() { if (ordersManager) ordersManager.applyFilters(); }
function clearFilters() { if (ordersManager) ordersManager.clearFilters(); }
function refreshOrders() { if (ordersManager) { ordersManager.loadOrders().then(() => { if (ordersManager) ordersManager.showNotification('Pedidos atualizados!', 'success'); }); } }
function openOrderDetails(orderId) { if (ordersManager) ordersManager.openOrderDetails(orderId); }
function closeOrderDetailsModal() { if (ordersManager) ordersManager.closeOrderDetailsModal(); }

// FUNÇÕES DE STATUS (AGORA CHAMAM A CLASSE)
async function updateOrderStatusFromDetails(orderId, newStatus) { if (ordersManager) { await ordersManager.updateOrderStatus(orderId, newStatus); ordersManager.closeOrderDetailsModal(); } }
async function updateOrderStatusFromCard(orderId, newStatus) { if (ordersManager) { await ordersManager.updateOrderStatus(orderId, newStatus); } }

function openFinalizarMesaModal(orderId) { if (!ordersManager) return; ordersManager.currentOrderForMesaFinalization = orderId; const modal = document.getElementById('finalizarMesaModal'); const order = ordersManager.orders.find(o => o.id === orderId); if (modal && order) { const totalDisplay = document.getElementById('mesaFinalTotalDisplay'); if (totalDisplay) { totalDisplay.textContent = parseFloat(order.total || order.total_amount || 0).toFixed(2).replace('.', ','); } modal.classList.add('show'); } }
function closeFinalizarMesaModal() { const modal = document.getElementById('finalizarMesaModal'); if (modal) { modal.classList.remove('show'); } if (ordersManager) { ordersManager.currentOrderForMesaFinalization = null; } }

async function confirmMesaPaymentAndFinish() {
    const paymentMethod = document.getElementById('mesaFinalPaymentMethod')?.value;
    const orderId = ordersManager?.currentOrderForMesaFinalization;
    if (!orderId || !ordersManager) { ordersManager?.showNotification('Erro: pedido de mesa não identificado.', 'error'); return; }
    if (!paymentMethod) { ordersManager.showNotification('Selecione uma forma de pagamento.', 'warning'); return; }
    try {
        await supabase.from('orders').update({ status: 'encerrado', payment_method: paymentMethod, updated_at: new Date().toISOString() }).eq('id', orderId);
        ordersManager.showNotification('Mesa encerrada com sucesso!', 'success');
        await ordersManager.loadOrders();
        closeFinalizarMesaModal();
        closeOrderDetailsModal();
    } catch (error) {
        console.error('❌ Erro ao finalizar mesa:', error);
        ordersManager.showNotification('Erro ao finalizar mesa. Tente novamente.', 'error');
    }
}

// ===== FUNÇÕES DE NOTIFICAÇÃO =====
function hideNewOrderNotification() { const modal = document.getElementById('newOrderNotificationModal'); if (modal) { modal.classList.remove('show'); } currentNewOrderForNotification = null; }
function acceptNewOrderFromNotification() { if (!currentNewOrderForNotification || !ordersManager) return; ordersManager.updateOrderStatus(currentNewOrderForNotification.id, 'aceito').then(() => { hideNewOrderNotification(); if (ordersManager) ordersManager.showNotification('Pedido aceito com sucesso!', 'success'); }); }

// ===== FUNÇÕES DE VERIFICAÇÃO =====
function startNewOrderChecking() { console.log('🔔 Sistema de verificação de novos pedidos iniciado'); }
function startAcceptedOrdersChecking() { console.log('🤖 Sistema de verificação de pedidos aceitos iniciado'); }

// ===== FUNÇÕES UTILITÁRIAS =====
function showCustomConfirmation(message, title = 'Confirmação') {
    return new Promise((resolve) => {
        const modalHtml = `
                <div class="modal" id="customConfirmationDialog" style="z-index: 16000; display:flex;">
                    <div class="modal-content" style="max-width: 400px;">
                        <div class="modal-header"><h3>${title}</h3><button class="modal-close">&times;</button></div>
                        <div class="modal-body" style="text-align: center; padding: 2rem;"><p>${message}</p></div>
                        <div style="padding: 1.5rem; border-top: 1px solid #e9ecef; display: flex; justify-content: center; gap: 1rem;">
                            <button class="btn btn-secondary" id="cancelConfirmBtn">Cancelar</button>
                            <button class="btn btn-primary" id="confirmConfirmBtn">Confirmar</button>
                        </div>
                    </div>
                </div>`;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        const dialog = document.getElementById('customConfirmationDialog');
        const close = () => { dialog.remove(); resolve(false); };
        const confirm = () => { dialog.remove(); resolve(true); };
        dialog.querySelector('.modal-close').onclick = close;
        dialog.querySelector('#cancelConfirmBtn').onclick = close;
        dialog.querySelector('#confirmConfirmBtn').onclick = confirm;
    });
}

async function signOut() { if (await showCustomConfirmation('Deseja realmente sair?', 'Sair')) { localStorage.removeItem('restaurant_id'); window.location.href = 'login.html'; } }

// ===== FUNÇÕES DE VALIDAÇÃO E FORMATAÇÃO =====
function toggleDeliveryChangeFields() { document.getElementById('deliveryChangeFields').style.display = document.getElementById('deliveryPaymentMethod').value === 'money' ? 'block' : 'none'; }
function toggleBalcaoChangeFields() { document.getElementById('balcaoChangeFields').style.display = document.getElementById('balcaoPaymentMethod').value === 'money' ? 'block' : 'none'; }
function toggleMesaChangeFields() { document.getElementById('mesaChangeFields').style.display = document.getElementById('mesaPaymentMethod').value === 'money' ? 'block' : 'none'; }
function toggleFinalChangeFields() { document.getElementById('finalChangeFields').style.display = document.getElementById('finalPaymentMethod').value === 'money' ? 'block' : 'none'; }
function toggleFinalMesaChangeFields() { document.getElementById('mesaFinalChangeFields').style.display = document.getElementById('mesaFinalPaymentMethod').value === 'money' ? 'block' : 'none'; }
function calculateChange(total, changeFor) { return changeFor >= total ? (changeFor - total).toFixed(2) : '0.00'; }
function calculateDeliveryChange() { const total = parseFloat(document.getElementById('deliveryTotal').value); const changeFor = parseFloat(document.getElementById('deliveryChangeForAmount').value); const change = calculateChange(total, changeFor); document.getElementById('deliveryChangeAmount').value = change; document.getElementById('deliveryChangeDisplay').textContent = change.replace('.', ','); document.getElementById('deliveryChangeCalculation').style.display = change > 0 ? 'block' : 'none'; }
function calculateBalcaoChange() { const total = parseFloat(document.getElementById('balcaoTotal').value); const changeFor = parseFloat(document.getElementById('balcaoChangeForAmount').value); const change = calculateChange(total, changeFor); document.getElementById('balcaoChangeAmount').value = change; document.getElementById('balcaoChangeDisplay').textContent = change.replace('.', ','); document.getElementById('balcaoChangeCalculation').style.display = change > 0 ? 'block' : 'none'; }
function calculateMesaChange() { const total = parseFloat(document.getElementById('mesaTotal').value); const changeFor = parseFloat(document.getElementById('mesaChangeForAmount').value); const change = calculateChange(total, changeFor); document.getElementById('mesaChangeAmount').value = change; document.getElementById('mesaChangeDisplay').textContent = change.replace('.', ','); document.getElementById('mesaChangeCalculation').style.display = change > 0 ? 'block' : 'none'; }
function calculateFinalChange() { const total = parseFloat(document.getElementById('mesaFinalTotalDisplay').textContent.replace(',', '.')); const changeFor = parseFloat(document.getElementById('finalChangeForAmount').value); const change = calculateChange(total, changeFor); document.getElementById('finalChangeAmount').value = change; document.getElementById('finalChangeDisplay').textContent = change.replace('.', ','); document.getElementById('finalChangeCalculation').style.display = change > 0 ? 'block' : 'none'; }
function calculateFinalMesaChange() { const total = parseFloat(document.getElementById('mesaFinalTotalDisplay').textContent.replace(',', '.')); const changeFor = parseFloat(document.getElementById('mesaFinalChangeForAmount').value); const change = calculateChange(total, changeFor); document.getElementById('mesaFinalChangeAmount').value = change; document.getElementById('mesaFinalChangeDisplay').textContent = change.replace('.', ','); document.getElementById('mesaFinalChangeCalculation').style.display = change > 0 ? 'block' : 'none'; }
function checkMesaAvailability() { const mesaNumber = document.getElementById('mesaNumber')?.value; const availabilityMessage = document.getElementById('mesaAvailabilityMessage'); if (!mesaNumber || !availabilityMessage) return; const occupiedTables = ['3', '7']; if (occupiedTables.includes(mesaNumber)) { availabilityMessage.innerHTML = `<div style="background:#f8d7da;color:#721c24;padding:1rem;border-radius:var(--border-radius);"><i class="fas fa-exclamation-triangle"></i> <strong>Atenção:</strong> Mesa ${mesaNumber} já está ocupada. Deseja continuar mesmo assim?</div>`; availabilityMessage.style.display = 'block'; } else { availabilityMessage.innerHTML = `<div style="background:#d4edda;color:#155724;padding:1rem;border-radius:var(--border-radius);"><i class="fas fa-check-circle"></i> <strong>Disponível:</strong> Mesa ${mesaNumber} está livre.</div>`; availabilityMessage.style.display = 'block'; } }

// ===== FUNÇÕES DE REGISTRO DE CLIENTE =====
function openCustomerRegistrationModal() { document.getElementById('customerRegistrationModal').classList.add('show'); }
function closeCustomerRegistrationModal() { document.getElementById('customerRegistrationModal').classList.remove('show'); document.getElementById('customerRegistrationForm')?.reset(); }
function formatCEP(input) { let v = input.value.replace(/\D/g, ''); if (v.length > 5) v = v.replace(/^(\d{5})(\d)/, '$1-$2'); input.value = v; }
async function handleCustomerRegistration(event) { event.preventDefault(); const customerData = { name: document.getElementById('newCustomerName')?.value.trim(), phone: document.getElementById('newCustomerPhone')?.value.trim(), email: document.getElementById('newCustomerEmail')?.value.trim(), birth_date: document.getElementById('newCustomerBirthDate')?.value, cep: document.getElementById('newCustomerCep')?.value.trim(), address: document.getElementById('newCustomerRua')?.value.trim(), number: document.getElementById('newCustomerNumber')?.value.trim(), complement: document.getElementById('newCustomerComplement')?.value.trim(), neighborhood: document.getElementById('newCustomerBairro')?.value.trim(), city: document.getElementById('newCustomerCidade')?.value.trim(), state: document.getElementById('newCustomerUf')?.value.trim() }; if (!customerData.name || !customerData.phone) { if (ordersManager) ordersManager.showNotification('Nome e telefone são obrigatórios', 'warning'); return; } try { await supabase.from('customers').insert([{ restaurant_id: currentRestaurant?.id, ...customerData }]); if (ordersManager) ordersManager.showNotification('Cliente cadastrado com sucesso!', 'success'); closeCustomerRegistrationModal(); } catch (error) { console.error('❌ Erro ao cadastrar cliente:', error); if (ordersManager) ordersManager.showNotification('Erro ao cadastrar cliente: ' + error.message, 'error'); } }

// ===== FUNÇÕES DE PLACEHOLDER =====
function closeAddProductModal() { document.getElementById('addProductModal')?.classList.remove('show'); }
function closeEditItemModal() { document.getElementById('editItemModal')?.classList.remove('show'); }
function addProductToOrder() { console.log('addProductToOrder - placeholder'); }
function updateOrderItem() { console.log('updateOrderItem - placeholder'); }
function filterProducts() { console.log('filterProducts - placeholder'); }

// ===== INICIALIZAÇÃO DA APLICAÇÃO =====
document.addEventListener('DOMContentLoaded', checkAuthenticationAndLoadConfig);
// Adiciona o event listener para a primeira interação do usuário, ativando o AudioContext.
document.addEventListener('click', resumeAudioContext, { once: true });


// ===== EVENT LISTENERS GLOBAIS =====
document.addEventListener('click', (e) => { if (e.target.classList.contains('modal')) e.target.classList.remove('show'); });

// ===== FUNÇÕES ESPECÍFICAS PARA DETALHES DE PEDIDOS (DELEGAÇÃO) =====
// Funções que delegam a chamada para a instância `ordersManager`
function openDelivererSelectionModal(orderId) { if (ordersManager) ordersManager.openDelivererSelectionModal(orderId); }
function confirmDelivererSelection() { if (ordersManager) ordersManager.confirmDelivererSelection(); }
function openPaymentMethodModal(orderId) { if (ordersManager) ordersManager.openPaymentMethodModal(orderId); }
async function confirmPaymentAndFinish() { if (ordersManager) await ordersManager.confirmPaymentAndFinish(); }

// Manter as funções originais que não estavam quebradas, mas renomeando para evitar conflito.
function openOrderDetailsComplete(orderId) { openOrderDetails(orderId); }
function getOrderDetailActionsComplete(order) { return getOrderDetailActions(order); }
async function updateOrderStatusComplete(orderId, newStatus) { if (ordersManager) await ordersManager.updateOrderStatus(orderId, newStatus); }
async function loadDeliverersComplete(selectElement) { if (ordersManager) await ordersManager.loadDeliverers(selectElement); }
async function confirmDelivererSelectionComplete() { if (ordersManager) await ordersManager.confirmDelivererSelection(); }
function openPaymentMethodModalComplete(orderId) { if (ordersManager) ordersManager.openPaymentMethodModal(orderId); }
async function confirmPaymentAndFinishComplete() { if (ordersManager) await ordersManager.confirmPaymentAndFinish(); }
function openFinalizarMesaModalComplete(orderId) { openFinalizarMesaModal(orderId); }
async function confirmMesaPaymentAndFinishComplete() { await confirmMesaPaymentAndFinish(); }

</script>
</body>
</html>
